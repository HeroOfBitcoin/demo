class MemoryView{constructor(a,b){this.buffer=a,this.view=new DataView(this.buffer,typeof b=='number'?b:0),this.mask=a.byteLength-1,this.resetMask()}resetMask(){this.mask8=this.mask&4294967295,this.mask16=this.mask&4294967294,this.mask32=this.mask&4294967292}load8(a){return this.view.getInt8(a&this.mask8)}load16(a){return this.view.getInt16(a&this.mask,!0)}loadU8(a){return this.view.getUint8(a&this.mask8)}loadU16(a){return this.view.getUint16(a&this.mask,!0)}load32(a){var b=(a&3)<<3,c=this.view.getInt32(a&this.mask32,!0);return c>>>b|c<<32-b}store8(a,b){this.view.setInt8(a&this.mask8,b)}store16(a,b){this.view.setInt16(a&this.mask16,b,!0)}store32(a,b){this.view.setInt32(a&this.mask32,b,!0)}invalidatePage(a){}replaceData(b,a){this.buffer=b,this.view=new DataView(this.buffer,typeof a=='number'?a:0),this.icache&&(this.icache=new Array(this.icache.length))}}class MemoryBlock extends MemoryView{constructor(a,b){super(new ArrayBuffer(a)),this.ICACHE_PAGE_BITS=b,this.PAGE_MASK=(2<<this.ICACHE_PAGE_BITS)-1,this.icache=new Array(a>>this.ICACHE_PAGE_BITS+1)}invalidatePage(b){var a=this.icache[(b&this.mask)>>this.ICACHE_PAGE_BITS];a&&(a.invalid=!0)}}class ROMView extends MemoryView{constructor(a,b){super(a,b),this.ICACHE_PAGE_BITS=10,this.PAGE_MASK=(2<<this.ICACHE_PAGE_BITS)-1,this.icache=new Array(a.byteLength>>this.ICACHE_PAGE_BITS+1),this.mask=33554431,this.resetMask()}store8(a,b){}store16(a,b){a<202&&a>=196&&(this.gpio||(this.gpio=this.mmu.allocGPIO(this)),this.gpio.store16(a,b))}store32(a,b){a<202&&a>=196&&(this.gpio||(this.gpio=this.mmu.allocGPIO(this)),this.gpio.store32(a,b))}}class BIOSView extends MemoryView{constructor(a,b){super(a,b),this.ICACHE_PAGE_BITS=16,this.PAGE_MASK=(2<<this.ICACHE_PAGE_BITS)-1,this.icache=new Array(1)}load8(a){return a>=this.buffer.byteLength?-1:this.view.getInt8(a)}load16(a){return a>=this.buffer.byteLength?-1:this.view.getInt16(a,!0)}loadU8(a){return a>=this.buffer.byteLength?-1:this.view.getUint8(a)}loadU16(a){return a>=this.buffer.byteLength?-1:this.view.getUint16(a,!0)}load32(a){return a>=this.buffer.byteLength?-1:this.view.getInt32(a,!0)}store8(a,b){}store16(a,b){}store32(a,b){}}class BadMemory{constructor(a,b){this.cpu=b,this.mmu=a}load8(a){return this.mmu.load8(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth+(a&3))}load16(a){return this.mmu.load16(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth+(a&2))}loadU8(a){return this.mmu.loadU8(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth+(a&3))}loadU16(a){return this.mmu.loadU16(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth+(a&2))}load32(b){if(this.cpu.execMode==this.cpu.MODE_ARM)return this.mmu.load32(this.cpu.gprs[this.cpu.gprs.PC]-this.cpu.instructionWidth);var a=this.mmu.loadU16(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth);return a|a<<16}store8(a,b){}store16(a,b){}store32(a,b){}invalidatePage(a){}}class GameBoyAdvanceMMU{constructor(){this.REGION_BIOS=0,this.REGION_WORKING_RAM=2,this.REGION_WORKING_IRAM=3,this.REGION_IO=4,this.REGION_PALETTE_RAM=5,this.REGION_VRAM=6,this.REGION_OAM=7,this.REGION_CART0=8,this.REGION_CART1=10,this.REGION_CART2=12,this.REGION_CART_SRAM=14,this.BASE_BIOS=0,this.BASE_WORKING_RAM=33554432,this.BASE_WORKING_IRAM=50331648,this.BASE_IO=67108864,this.BASE_PALETTE_RAM=83886080,this.BASE_VRAM=100663296,this.BASE_OAM=117440512,this.BASE_CART0=134217728,this.BASE_CART1=167772160,this.BASE_CART2=201326592,this.BASE_CART_SRAM=234881024,this.BASE_MASK=251658240,this.BASE_OFFSET=24,this.OFFSET_MASK=16777215,this.SIZE_BIOS=16384,this.SIZE_WORKING_RAM=262144,this.SIZE_WORKING_IRAM=32768,this.SIZE_IO=1024,this.SIZE_PALETTE_RAM=1024,this.SIZE_VRAM=98304,this.SIZE_OAM=1024,this.SIZE_CART0=33554432,this.SIZE_CART1=33554432,this.SIZE_CART2=33554432,this.SIZE_CART_SRAM=32768,this.SIZE_CART_FLASH512=65536,this.SIZE_CART_FLASH1M=131072,this.SIZE_CART_EEPROM=8192,this.DMA_TIMING_NOW=0,this.DMA_TIMING_VBLANK=1,this.DMA_TIMING_HBLANK=2,this.DMA_TIMING_CUSTOM=3,this.DMA_INCREMENT=0,this.DMA_DECREMENT=1,this.DMA_FIXED=2,this.DMA_INCREMENT_RELOAD=3,this.DMA_OFFSET=[1,-1,0,1],this.WAITSTATES=[0,0,2,0,0,0,0,0,4,4,4,4,4,4,4],this.WAITSTATES_32=[0,0,5,0,0,1,0,1,7,7,9,9,13,13,8],this.WAITSTATES_SEQ=[0,0,2,0,0,0,0,0,2,2,4,4,8,8,4],this.WAITSTATES_SEQ_32=[0,0,5,0,0,1,0,1,5,5,9,9,17,17,8],this.NULLWAIT=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(var a=15;a<256;++a)this.WAITSTATES[a]=0,this.WAITSTATES_32[a]=0,this.WAITSTATES_SEQ[a]=0,this.WAITSTATES_SEQ_32[a]=0,this.NULLWAIT[a]=0;this.ROM_WS=[4,3,2,8],this.ROM_WS_SEQ=[[2,1],[4,1],[8,1]],this.ICACHE_PAGE_BITS=8,this.PAGE_MASK=(2<<this.ICACHE_PAGE_BITS)-1,this.bios=null}mmap(a,b){this.memory[a]=b}clear(){this.badMemory=new BadMemory(this,this.cpu),this.memory=[this.bios,this.badMemory,new MemoryBlock(this.SIZE_WORKING_RAM,9),new MemoryBlock(this.SIZE_WORKING_IRAM,7),null,null,null,null,this.badMemory,this.badMemory,this.badMemory,this.badMemory,this.badMemory,this.badMemory,this.badMemory,this.badMemory];for(var a=16;a<256;++a)this.memory[a]=this.badMemory;this.waitstates=this.WAITSTATES.slice(0),this.waitstatesSeq=this.WAITSTATES_SEQ.slice(0),this.waitstates32=this.WAITSTATES_32.slice(0),this.waitstatesSeq32=this.WAITSTATES_SEQ_32.slice(0),this.waitstatesPrefetch=this.WAITSTATES_SEQ.slice(0),this.waitstatesPrefetch32=this.WAITSTATES_SEQ_32.slice(0),this.cart=null,this.save=null,this.DMA_REGISTER=[this.core.io.DMA0CNT_HI>>1,this.core.io.DMA1CNT_HI>>1,this.core.io.DMA2CNT_HI>>1,this.core.io.DMA3CNT_HI>>1]}freeze(){return{ram:Serializer.prefix(this.memory[this.REGION_WORKING_RAM].buffer),iram:Serializer.prefix(this.memory[this.REGION_WORKING_IRAM].buffer)}}defrost(a){this.memory[this.REGION_WORKING_RAM].replaceData(a.ram),this.memory[this.REGION_WORKING_IRAM].replaceData(a.iram)}loadBios(a,b){this.bios=new BIOSView(a),this.bios.real=!!b}loadRom(f,m){var d={title:null,code:null,maker:null,memory:f,saveType:null},b=new ROMView(f),h,l,a,c,j,k,e,i,g;if(b.view.getUint8(178)!=150)return null;if(b.mmu=this,this.memory[this.REGION_CART0]=b,this.memory[this.REGION_CART1]=b,this.memory[this.REGION_CART2]=b,f.byteLength>16777216&&(h=new ROMView(f,16777216),this.memory[this.REGION_CART0+1]=h,this.memory[this.REGION_CART1+1]=h,this.memory[this.REGION_CART2+1]=h),m){l='';for(a=0;a<12;++a){if(c=b.loadU8(a+160),!c)break;l+=String.fromCharCode(c)}d.title=l,j='';for(a=0;a<4;++a){if(c=b.loadU8(a+172),!c)break;j+=String.fromCharCode(c)}d.code=j,k='';for(a=0;a<2;++a){if(c=b.loadU8(a+176),!c)break;k+=String.fromCharCode(c)}d.maker=k,e='',g=!1;for(a=228;a<f.byteLength&&!g;++a)switch(i=String.fromCharCode(b.loadU8(a)),e+=i,e){case'F':case'FL':case'FLA':case'FLAS':case'FLASH':case'FLASH_':case'FLASH5':case'FLASH51':case'FLASH512':case'FLASH512_':case'FLASH1':case'FLASH1M':case'FLASH1M_':case'S':case'SR':case'SRA':case'SRAM':case'SRAM_':case'E':case'EE':case'EEP':case'EEPR':case'EEPRO':case'EEPROM':case'EEPROM_':break;case'FLASH_V':case'FLASH512_V':case'FLASH1M_V':case'SRAM_V':case'EEPROM_V':g=!0;break;default:e=i;break}if(g)switch(d.saveType=e,e){case'FLASH_V':case'FLASH512_V':this.save=this.memory[this.REGION_CART_SRAM]=new FlashSavedata(this.SIZE_CART_FLASH512);break;case'FLASH1M_V':this.save=this.memory[this.REGION_CART_SRAM]=new FlashSavedata(this.SIZE_CART_FLASH1M);break;case'SRAM_V':this.save=this.memory[this.REGION_CART_SRAM]=new SRAMSavedata(this.SIZE_CART_SRAM);break;case'EEPROM_V':this.save=this.memory[this.REGION_CART2+1]=new EEPROMSavedata(this.SIZE_CART_EEPROM,this);break}this.save||(this.save=this.memory[this.REGION_CART_SRAM]=new SRAMSavedata(this.SIZE_CART_SRAM))}return this.cart=d,d}loadSavedata(a){this.save.replaceData(a)}load8(a){return this.memory[a>>>this.BASE_OFFSET].load8(a&16777215)}load16(a){return this.memory[a>>>this.BASE_OFFSET].load16(a&16777215)}load32(a){return this.memory[a>>>this.BASE_OFFSET].load32(a&16777215)}loadU8(a){return this.memory[a>>>this.BASE_OFFSET].loadU8(a&16777215)}loadU16(a){return this.memory[a>>>this.BASE_OFFSET].loadU16(a&16777215)}store8(a,d){var b=a&16777215,c=this.memory[a>>>this.BASE_OFFSET];c.store8(b,d),c.invalidatePage(b)}store16(a,d){var b=a&16777214,c=this.memory[a>>>this.BASE_OFFSET];c.store16(b,d),c.invalidatePage(b)}store32(c,d){var a=c&16777212,b=this.memory[c>>>this.BASE_OFFSET];b.store32(a,d),b.invalidatePage(a),b.invalidatePage(a+2)}waitPrefetch(a){this.cpu.cycles+=1+this.waitstatesPrefetch[a>>>this.BASE_OFFSET]}waitPrefetch32(a){this.cpu.cycles+=1+this.waitstatesPrefetch32[a>>>this.BASE_OFFSET]}wait(a){this.cpu.cycles+=1+this.waitstates[a>>>this.BASE_OFFSET]}wait32(a){this.cpu.cycles+=1+this.waitstates32[a>>>this.BASE_OFFSET]}waitSeq(a){this.cpu.cycles+=1+this.waitstatesSeq[a>>>this.BASE_OFFSET]}waitSeq32(a){this.cpu.cycles+=1+this.waitstatesSeq32[a>>>this.BASE_OFFSET]}waitMul(a){a&4294967040==4294967040||!(a&4294967040)?this.cpu.cycles+=1:a&4294901760==4294901760||!(a&4294901760)?this.cpu.cycles+=2:a&4278190080==4278190080||!(a&4278190080)?this.cpu.cycles+=3:this.cpu.cycles+=4}waitMulti32(a,b){this.cpu.cycles+=1+this.waitstates32[a>>>this.BASE_OFFSET],this.cpu.cycles+=(1+this.waitstatesSeq32[a>>>this.BASE_OFFSET])*(b-1)}addressToPage(a,b){return b>>this.memory[a].ICACHE_PAGE_BITS}accessPage(d,c){var b=this.memory[d],a=b.icache[c];return(!a||a.invalid)&&(a={thumb:new Array(1<<b.ICACHE_PAGE_BITS),arm:new Array(1<<b.ICACHE_PAGE_BITS-1),invalid:!1},b.icache[c]=a),a}scheduleDma(b,a){switch(a.timing){case this.DMA_TIMING_NOW:this.serviceDma(b,a);break;case this.DMA_TIMING_HBLANK:break;case this.DMA_TIMING_VBLANK:break;case this.DMA_TIMING_CUSTOM:switch(b){case 0:this.core.WARN('Discarding invalid DMA0 scheduling');break;case 1:case 2:this.cpu.irq.audio.scheduleFIFODma(b,a);break;case 3:this.cpu.irq.video.scheduleVCaptureDma(dma,a);break}}}runHblankDmas(){for(var b=0,a;b<this.cpu.irq.dma.length;++b)a=this.cpu.irq.dma[b],a.enable&&a.timing==this.DMA_TIMING_HBLANK&&this.serviceDma(b,a)}runVblankDmas(){for(var b=0,a;b<this.cpu.irq.dma.length;++b)a=this.cpu.irq.dma[b],a.enable&&a.timing==this.DMA_TIMING_VBLANK&&this.serviceDma(b,a)}serviceDma(r,a){var i,l,k,g,c,b,f,h,m,d,j,o,n,p,e,s,q,t;if(!a.enable)return;if(i=a.width,l=this.DMA_OFFSET[a.srcControl]*i,k=this.DMA_OFFSET[a.dstControl]*i,g=a.nextCount,c=a.nextSource&this.OFFSET_MASK,b=a.nextDest&this.OFFSET_MASK,f=a.nextSource>>>this.BASE_OFFSET,h=a.nextDest>>>this.BASE_OFFSET,m=this.memory[f],d=this.memory[h],j=null,o=null,n=4294967295,p=4294967295,d.ICACHE_PAGE_BITS){s=b+g*i>>d.ICACHE_PAGE_BITS;for(q=b>>d.ICACHE_PAGE_BITS;q<=s;++q)d.invalidatePage(q<<d.ICACHE_PAGE_BITS)}if((h==this.REGION_WORKING_RAM||h==this.REGION_WORKING_IRAM)&&(o=d.view,p=d.mask),(f==this.REGION_WORKING_RAM||f==this.REGION_WORKING_IRAM||f==this.REGION_CART0||f==this.REGION_CART1)&&(j=m.view,n=m.mask),m&&d)if(j&&o)if(i==4)for(c&=4294967292,b&=4294967292;g--;)e=j.getInt32(c&n),o.setInt32(b&p,e),c+=l,b+=k;else while(g--)e=j.getUint16(c&n),o.setUint16(b&p,e),c+=l,b+=k;else if(j)if(i==4)for(c&=4294967292,b&=4294967292;g--;)e=j.getInt32(c&n,!0),d.store32(b,e),c+=l,b+=k;else while(g--)e=j.getUint16(c&n,!0),d.store16(b,e),c+=l,b+=k;else if(i==4)for(c&=4294967292,b&=4294967292;g--;)e=m.load32(c),d.store32(b,e),c+=l,b+=k;else while(g--)e=m.loadU16(c),d.store16(b,e),c+=l,b+=k;else this.core.WARN('Invalid DMA');a.doIrq&&(a.nextIRQ=this.cpu.cycles+2,a.nextIRQ+=i==4?this.waitstates32[f]+this.waitstates32[h]:this.waitstates[f]+this.waitstates[h],a.nextIRQ+=(a.count-1)*(i==4?this.waitstatesSeq32[f]+this.waitstatesSeq32[h]:this.waitstatesSeq[f]+this.waitstatesSeq[h])),a.nextSource=c|f<<this.BASE_OFFSET,a.nextDest=b|h<<this.BASE_OFFSET,a.nextCount=g,a.repeat?(a.nextCount=a.count,a.dstControl==this.DMA_INCREMENT_RELOAD&&(a.nextDest=a.dest),this.scheduleDma(r,a)):(a.enable=!1,t=this.memory[this.REGION_IO],t.registers[this.DMA_REGISTER[r]]&=32736)}adjustTimings(a){var b=a&3,c=(a&12)>>2,d=(a&16)>>4,e=(a&96)>>5,f=(a&128)>>7,g=(a&768)>>8,h=(a&1024)>>10,i=a&16384;this.waitstates[this.REGION_CART_SRAM]=this.ROM_WS[b],this.waitstatesSeq[this.REGION_CART_SRAM]=this.ROM_WS[b],this.waitstates32[this.REGION_CART_SRAM]=this.ROM_WS[b],this.waitstatesSeq32[this.REGION_CART_SRAM]=this.ROM_WS[b],this.waitstates[this.REGION_CART0]=this.waitstates[this.REGION_CART0+1]=this.ROM_WS[c],this.waitstates[this.REGION_CART1]=this.waitstates[this.REGION_CART1+1]=this.ROM_WS[e],this.waitstates[this.REGION_CART2]=this.waitstates[this.REGION_CART2+1]=this.ROM_WS[g],this.waitstatesSeq[this.REGION_CART0]=this.waitstatesSeq[this.REGION_CART0+1]=this.ROM_WS_SEQ[0][d],this.waitstatesSeq[this.REGION_CART1]=this.waitstatesSeq[this.REGION_CART1+1]=this.ROM_WS_SEQ[1][f],this.waitstatesSeq[this.REGION_CART2]=this.waitstatesSeq[this.REGION_CART2+1]=this.ROM_WS_SEQ[2][h],this.waitstates32[this.REGION_CART0]=this.waitstates32[this.REGION_CART0+1]=this.waitstates[this.REGION_CART0]+1+this.waitstatesSeq[this.REGION_CART0],this.waitstates32[this.REGION_CART1]=this.waitstates32[this.REGION_CART1+1]=this.waitstates[this.REGION_CART1]+1+this.waitstatesSeq[this.REGION_CART1],this.waitstates32[this.REGION_CART2]=this.waitstates32[this.REGION_CART2+1]=this.waitstates[this.REGION_CART2]+1+this.waitstatesSeq[this.REGION_CART2],this.waitstatesSeq32[this.REGION_CART0]=this.waitstatesSeq32[this.REGION_CART0+1]=2*this.waitstatesSeq[this.REGION_CART0]+1,this.waitstatesSeq32[this.REGION_CART1]=this.waitstatesSeq32[this.REGION_CART1+1]=2*this.waitstatesSeq[this.REGION_CART1]+1,this.waitstatesSeq32[this.REGION_CART2]=this.waitstatesSeq32[this.REGION_CART2+1]=2*this.waitstatesSeq[this.REGION_CART2]+1,i?(this.waitstatesPrefetch[this.REGION_CART0]=this.waitstatesPrefetch[this.REGION_CART0+1]=0,this.waitstatesPrefetch[this.REGION_CART1]=this.waitstatesPrefetch[this.REGION_CART1+1]=0,this.waitstatesPrefetch[this.REGION_CART2]=this.waitstatesPrefetch[this.REGION_CART2+1]=0,this.waitstatesPrefetch32[this.REGION_CART0]=this.waitstatesPrefetch32[this.REGION_CART0+1]=0,this.waitstatesPrefetch32[this.REGION_CART1]=this.waitstatesPrefetch32[this.REGION_CART1+1]=0,this.waitstatesPrefetch32[this.REGION_CART2]=this.waitstatesPrefetch32[this.REGION_CART2+1]=0):(this.waitstatesPrefetch[this.REGION_CART0]=this.waitstatesPrefetch[this.REGION_CART0+1]=this.waitstatesSeq[this.REGION_CART0],this.waitstatesPrefetch[this.REGION_CART1]=this.waitstatesPrefetch[this.REGION_CART1+1]=this.waitstatesSeq[this.REGION_CART1],this.waitstatesPrefetch[this.REGION_CART2]=this.waitstatesPrefetch[this.REGION_CART2+1]=this.waitstatesSeq[this.REGION_CART2],this.waitstatesPrefetch32[this.REGION_CART0]=this.waitstatesPrefetch32[this.REGION_CART0+1]=this.waitstatesSeq32[this.REGION_CART0],this.waitstatesPrefetch32[this.REGION_CART1]=this.waitstatesPrefetch32[this.REGION_CART1+1]=this.waitstatesSeq32[this.REGION_CART1],this.waitstatesPrefetch32[this.REGION_CART2]=this.waitstatesPrefetch32[this.REGION_CART2+1]=this.waitstatesSeq32[this.REGION_CART2])}saveNeedsFlush(){return this.save.writePending}flushSave(){this.save.writePending=!1}allocGPIO(a){return new GameBoyAdvanceGPIO(this.core,a)}}