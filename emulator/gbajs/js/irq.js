class GameBoyAdvanceInterruptHandler{constructor(){this.FREQUENCY=16777216,this.cpu=null,this.enable=!1,this.IRQ_VBLANK=0,this.IRQ_HBLANK=1,this.IRQ_VCOUNTER=2,this.IRQ_TIMER0=3,this.IRQ_TIMER1=4,this.IRQ_TIMER2=5,this.IRQ_TIMER3=6,this.IRQ_SIO=7,this.IRQ_DMA0=8,this.IRQ_DMA1=9,this.IRQ_DMA2=10,this.IRQ_DMA3=11,this.IRQ_KEYPAD=12,this.IRQ_GAMEPAK=13,this.MASK_VBLANK=1,this.MASK_HBLANK=2,this.MASK_VCOUNTER=4,this.MASK_TIMER0=8,this.MASK_TIMER1=16,this.MASK_TIMER2=32,this.MASK_TIMER3=64,this.MASK_SIO=128,this.MASK_DMA0=256,this.MASK_DMA1=512,this.MASK_DMA2=1024,this.MASK_DMA3=2048,this.MASK_KEYPAD=4096,this.MASK_GAMEPAK=8192}clear(){var a;this.enable=!1,this.enabledIRQs=0,this.interruptFlags=0,this.dma=new Array;for(a=0;a<4;++a)this.dma.push({source:0,dest:0,count:0,nextSource:0,nextDest:0,nextCount:0,srcControl:0,dstControl:0,repeat:!1,width:0,drq:!1,timing:0,doIrq:!1,enable:!1,nextIRQ:0});this.timersEnabled=0,this.timers=new Array;for(a=0;a<4;++a)this.timers.push({reload:0,oldReload:0,prescaleBits:0,countUp:!1,doIrq:!1,enable:!1,lastEvent:0,nextEvent:0,overflowInterval:1});this.nextEvent=0,this.springIRQ=!1,this.resetSP()}freeze(){return{enable:this.enable,enabledIRQs:this.enabledIRQs,interruptFlags:this.interruptFlags,dma:this.dma,timers:this.timers,nextEvent:this.nextEvent,springIRQ:this.springIRQ}}defrost(a){this.enable=a.enable,this.enabledIRQs=a.enabledIRQs,this.interruptFlags=a.interruptFlags,this.dma=a.dma,this.timers=a.timers,this.timersEnabled=0,this.timers[0].enable&&++this.timersEnabled,this.timers[1].enable&&++this.timersEnabled,this.timers[2].enable&&++this.timersEnabled,this.timers[3].enable&&++this.timersEnabled,this.nextEvent=a.nextEvent,this.springIRQ=a.springIRQ}updateTimers(){var a,b;if(this.nextEvent>this.cpu.cycles)return;this.springIRQ&&(this.cpu.raiseIRQ(),this.springIRQ=!1),this.video.updateTimers(this.cpu),this.audio.updateTimers(),this.timersEnabled&&(a=this.timers[0],a.enable&&this.cpu.cycles>=a.nextEvent&&(a.lastEvent=a.nextEvent,a.nextEvent+=a.overflowInterval,this.io.registers[this.io.TM0CNT_LO>>1]=a.reload,a.oldReload=a.reload,a.doIrq&&this.raiseIRQ(this.IRQ_TIMER0),this.audio.enabled&&(this.audio.enableChannelA&&!this.audio.soundTimerA&&this.audio.dmaA>=0&&this.audio.sampleFifoA(),this.audio.enableChannelB&&!this.audio.soundTimerB&&this.audio.dmaB>=0&&this.audio.sampleFifoB()),a=this.timers[1],a.countUp&&++this.io.registers[this.io.TM1CNT_LO>>1]==65536&&(a.nextEvent=this.cpu.cycles)),a=this.timers[1],a.enable&&this.cpu.cycles>=a.nextEvent&&(a.lastEvent=a.nextEvent,a.nextEvent+=a.overflowInterval,(!a.countUp||this.io.registers[this.io.TM1CNT_LO>>1]==65536)&&(this.io.registers[this.io.TM1CNT_LO>>1]=a.reload),a.oldReload=a.reload,a.doIrq&&this.raiseIRQ(this.IRQ_TIMER1),a.countUp&&(a.nextEvent=0),this.audio.enabled&&(this.audio.enableChannelA&&this.audio.soundTimerA&&this.audio.dmaA>=0&&this.audio.sampleFifoA(),this.audio.enableChannelB&&this.audio.soundTimerB&&this.audio.dmaB>=0&&this.audio.sampleFifoB()),a=this.timers[2],a.countUp&&++this.io.registers[this.io.TM2CNT_LO>>1]==65536&&(a.nextEvent=this.cpu.cycles)),a=this.timers[2],a.enable&&this.cpu.cycles>=a.nextEvent&&(a.lastEvent=a.nextEvent,a.nextEvent+=a.overflowInterval,(!a.countUp||this.io.registers[this.io.TM2CNT_LO>>1]==65536)&&(this.io.registers[this.io.TM2CNT_LO>>1]=a.reload),a.oldReload=a.reload,a.doIrq&&this.raiseIRQ(this.IRQ_TIMER2),a.countUp&&(a.nextEvent=0),a=this.timers[3],a.countUp&&++this.io.registers[this.io.TM3CNT_LO>>1]==65536&&(a.nextEvent=this.cpu.cycles)),a=this.timers[3],a.enable&&this.cpu.cycles>=a.nextEvent&&(a.lastEvent=a.nextEvent,a.nextEvent+=a.overflowInterval,(!a.countUp||this.io.registers[this.io.TM3CNT_LO>>1]==65536)&&(this.io.registers[this.io.TM3CNT_LO>>1]=a.reload),a.oldReload=a.reload,a.doIrq&&this.raiseIRQ(this.IRQ_TIMER3),a.countUp&&(a.nextEvent=0))),b=this.dma[0],b.enable&&b.doIrq&&b.nextIRQ&&this.cpu.cycles>=b.nextIRQ&&(b.nextIRQ=0,this.raiseIRQ(this.IRQ_DMA0)),b=this.dma[1],b.enable&&b.doIrq&&b.nextIRQ&&this.cpu.cycles>=b.nextIRQ&&(b.nextIRQ=0,this.raiseIRQ(this.IRQ_DMA1)),b=this.dma[2],b.enable&&b.doIrq&&b.nextIRQ&&this.cpu.cycles>=b.nextIRQ&&(b.nextIRQ=0,this.raiseIRQ(this.IRQ_DMA2)),b=this.dma[3],b.enable&&b.doIrq&&b.nextIRQ&&this.cpu.cycles>=b.nextIRQ&&(b.nextIRQ=0,this.raiseIRQ(this.IRQ_DMA3)),this.pollNextEvent()}resetSP(){this.cpu.switchMode(this.cpu.MODE_SUPERVISOR),this.cpu.gprs[this.cpu.SP]=50364384,this.cpu.switchMode(this.cpu.MODE_IRQ),this.cpu.gprs[this.cpu.SP]=50364320,this.cpu.switchMode(this.cpu.MODE_SYSTEM),this.cpu.gprs[this.cpu.SP]=50364160}swi32(a){this.swi(a>>16)}swi(C){var A,G,a,p,q,s,F,E,D,d,f,o,g,v,y,e,x,w,t,u,l,m,n,c,b,i,k,h,j,B,z,r,H;if(this.core.mmu.bios.real){this.cpu.raiseTrap();return}switch(C){case 0:A=this.core.mmu.memory[this.core.mmu.REGION_WORKING_IRAM],G=A.loadU8(32762);for(a=32256;a<32768;a+=4)A.store32(a,0);this.resetSP(),G?this.cpu.gprs[this.cpu.LR]=33554432:this.cpu.gprs[this.cpu.LR]=134217728,this.cpu.switchExecMode(this.cpu.MODE_ARM),this.cpu.instruction.writesPC=!0,this.cpu.gprs[this.cpu.PC]=this.cpu.gprs[this.cpu.LR];break;case 1:if(p=this.cpu.gprs[0],p&1&&(this.core.mmu.memory[this.core.mmu.REGION_WORKING_RAM]=new MemoryBlock(this.core.mmu.SIZE_WORKING_RAM,9)),p&2)for(a=0;a<this.core.mmu.SIZE_WORKING_IRAM-512;a+=4)this.core.mmu.memory[this.core.mmu.REGION_WORKING_IRAM].store32(a,0);p&28&&this.video.renderPath.clearSubsets(this.core.mmu,p),p&224&&this.core.STUB('Unimplemented RegisterRamReset');break;case 2:this.halt();break;case 5:this.cpu.gprs[0]=1,this.cpu.gprs[1]=1;case 4:if(this.enable||this.io.store16(this.io.IME,1),!this.cpu.gprs[0]&&this.interruptFlags&this.cpu.gprs[1])return;this.dismissIRQs(4294967295),this.cpu.raiseTrap();break;case 6:q=(this.cpu.gprs[0]|0)/(this.cpu.gprs[1]|0),s=(this.cpu.gprs[0]|0)%(this.cpu.gprs[1]|0),this.cpu.gprs[0]=q|0,this.cpu.gprs[1]=s|0,this.cpu.gprs[3]=Math.abs(q|0);break;case 7:q=(this.cpu.gprs[1]|0)/(this.cpu.gprs[0]|0),s=(this.cpu.gprs[1]|0)%(this.cpu.gprs[0]|0),this.cpu.gprs[0]=q|0,this.cpu.gprs[1]=s|0,this.cpu.gprs[3]=Math.abs(q|0);break;case 8:F=Math.sqrt(this.cpu.gprs[0]),this.cpu.gprs[0]=F|0;break;case 10:E=this.cpu.gprs[0]/16384,D=this.cpu.gprs[1]/16384,this.cpu.gprs[0]=Math.atan2(D,E)/(2*Math.PI)*65536;break;case 11:if(d=this.cpu.gprs[0],f=this.cpu.gprs[1],o=this.cpu.gprs[2],g=o&1048575,v=o&16777216,y=o&67108864?4:2,v)if(y==4){d&=4294967292,f&=4294967292,e=this.cpu.mmu.load32(d);for(a=0;a<g;++a)this.cpu.mmu.store32(f+(a<<2),e)}else{d&=4294967294,f&=4294967294,e=this.cpu.mmu.load16(d);for(a=0;a<g;++a)this.cpu.mmu.store16(f+(a<<1),e)}else if(y==4){d&=4294967292,f&=4294967292;for(a=0;a<g;++a)e=this.cpu.mmu.load32(d+(a<<2)),this.cpu.mmu.store32(f+(a<<2),e)}else{d&=4294967294,f&=4294967294;for(a=0;a<g;++a)e=this.cpu.mmu.load16(d+(a<<1)),this.cpu.mmu.store16(f+(a<<1),e)}return;case 12:if(d=this.cpu.gprs[0]&4294967292,f=this.cpu.gprs[1]&4294967292,o=this.cpu.gprs[2],g=o&1048575,g=g+7>>3<<3,v=o&16777216,v){e=this.cpu.mmu.load32(d);for(a=0;a<g;++a)this.cpu.mmu.store32(f+(a<<2),e)}else for(a=0;a<g;++a)e=this.cpu.mmu.load32(d+(a<<2)),this.cpu.mmu.store32(f+(a<<2),e);return;case 14:for(a=this.cpu.gprs[2],c=this.cpu.gprs[0],b=this.cpu.gprs[1];a--;)x=this.core.mmu.load32(c)/256,w=this.core.mmu.load32(c+4)/256,t=this.core.mmu.load16(c+8),u=this.core.mmu.load16(c+10),l=this.core.mmu.load16(c+12)/256,m=this.core.mmu.load16(c+14)/256,n=(this.core.mmu.loadU16(c+16)>>8)/128*Math.PI,c+=20,i=j=Math.cos(n),k=h=Math.sin(n),i*=l,k*=-l,h*=m,j*=m,B=x-(i*t+k*u),z=w-(h*t+j*u),this.core.mmu.store16(b,i*256|0),this.core.mmu.store16(b+2,k*256|0),this.core.mmu.store16(b+4,h*256|0),this.core.mmu.store16(b+6,j*256|0),this.core.mmu.store32(b+8,B*256|0),this.core.mmu.store32(b+12,z*256|0),b+=16;break;case 15:for(a=this.cpu.gprs[2],c=this.cpu.gprs[0],b=this.cpu.gprs[1],r=this.cpu.gprs[3];a--;)l=this.core.mmu.load16(c)/256,m=this.core.mmu.load16(c+2)/256,n=(this.core.mmu.loadU16(c+4)>>8)/128*Math.PI,c+=6,i=j=Math.cos(n),k=h=Math.sin(n),i*=l,k*=-l,h*=m,j*=m,this.core.mmu.store16(b,i*256|0),this.core.mmu.store16(b+r,k*256|0),this.core.mmu.store16(b+r*2,h*256|0),this.core.mmu.store16(b+r*3,j*256|0),b+=r*4;break;case 17:this.lz77(this.cpu.gprs[0],this.cpu.gprs[1],1);break;case 18:this.lz77(this.cpu.gprs[0],this.cpu.gprs[1],2);break;case 19:this.huffman(this.cpu.gprs[0],this.cpu.gprs[1]);break;case 20:this.rl(this.cpu.gprs[0],this.cpu.gprs[1],1);break;case 21:this.rl(this.cpu.gprs[0],this.cpu.gprs[1],2);break;case 31:H=this.cpu.mmu.load32(this.cpu.gprs[0]+4),this.cpu.gprs[0]=H/Math.pow(2,(180-this.cpu.gprs[1]-this.cpu.gprs[2]/256)/12)>>>0;break;default:throw'Unimplemented software interrupt: 0x'+C.toString(16)}}masterEnable(a){this.enable=a,this.enable&&this.enabledIRQs&this.interruptFlags&&this.cpu.raiseIRQ()}setInterruptsEnabled(a){this.enabledIRQs=a,this.enabledIRQs&this.MASK_SIO&&this.core.STUB('Serial I/O interrupts not implemented'),this.enabledIRQs&this.MASK_KEYPAD&&this.core.STUB('Keypad interrupts not implemented'),this.enable&&this.enabledIRQs&this.interruptFlags&&this.cpu.raiseIRQ()}pollNextEvent(){var b=this.video.nextEvent,a,d,c;this.audio.enabled&&(a=this.audio.nextEvent,(!b||a<b)&&(b=a)),this.timersEnabled&&(d=this.timers[0],a=d.nextEvent,d.enable&&a&&(!b||a<b)&&(b=a),d=this.timers[1],a=d.nextEvent,d.enable&&a&&(!b||a<b)&&(b=a),d=this.timers[2],a=d.nextEvent,d.enable&&a&&(!b||a<b)&&(b=a),d=this.timers[3],a=d.nextEvent,d.enable&&a&&(!b||a<b)&&(b=a)),c=this.dma[0],a=c.nextIRQ,c.enable&&c.doIrq&&a&&(!b||a<b)&&(b=a),c=this.dma[1],a=c.nextIRQ,c.enable&&c.doIrq&&a&&(!b||a<b)&&(b=a),c=this.dma[2],a=c.nextIRQ,c.enable&&c.doIrq&&a&&(!b||a<b)&&(b=a),c=this.dma[3],a=c.nextIRQ,c.enable&&c.doIrq&&a&&(!b||a<b)&&(b=a),this.core.ASSERT(b>=this.cpu.cycles,'Next event is before present'),this.nextEvent=b}waitForIRQ(){var a=this.testIRQ()||this.video.hblankIRQ||this.video.vblankIRQ||this.video.vcounterIRQ,b;if(this.timersEnabled&&(b=this.timers[0],a=a||b.doIrq,b=this.timers[1],a=a||b.doIrq,b=this.timers[2],a=a||b.doIrq,b=this.timers[3],a=a||b.doIrq),!a)return!1;for(;;){if(this.pollNextEvent(),!this.nextEvent)return!1;if(this.cpu.cycles=this.nextEvent,this.updateTimers(),this.interruptFlags)return!0}}testIRQ(){return!!(this.enable&&this.enabledIRQs&this.interruptFlags)&&(this.springIRQ=!0,this.nextEvent=this.cpu.cycles,!0)}raiseIRQ(a){this.interruptFlags|=1<<a,this.io.registers[this.io.IF>>1]=this.interruptFlags,this.enable&&this.enabledIRQs&1<<a&&this.cpu.raiseIRQ()}dismissIRQs(a){this.interruptFlags&=~a,this.io.registers[this.io.IF>>1]=this.interruptFlags}dmaSetSourceAddress(a,b){this.dma[a].source=b&4294967294}dmaSetDestAddress(a,b){this.dma[a].dest=b&4294967294}dmaSetWordCount(a,b){this.dma[a].count=b?b:a==3?65536:16384}dmaWriteControl(c,b){var a=this.dma[c],d=a.enable;a.dstControl=(b&96)>>5,a.srcControl=(b&384)>>7,a.repeat=!!(b&512),a.width=b&1024?4:2,a.drq=!!(b&2048),a.timing=(b&12288)>>12,a.doIrq=!!(b&16384),a.enable=!!(b&32768),a.nextIRQ=0,a.drq&&this.core.WARN('DRQ not implemented'),!d&&a.enable&&(a.nextSource=a.source,a.nextDest=a.dest,a.nextCount=a.count,this.cpu.mmu.scheduleDma(c,a))}timerSetReload(a,b){this.timers[a].reload=b&65535}timerWriteControl(b,c){var a=this.timers[b],d=a.prescaleBits,e;switch(c&3){case 0:a.prescaleBits=0;break;case 1:a.prescaleBits=6;break;case 2:a.prescaleBits=8;break;case 3:a.prescaleBits=10;break}a.countUp=!!(c&4),a.doIrq=!!(c&64),a.overflowInterval=65536-a.reload<<a.prescaleBits,e=a.enable,a.enable=!!((c&128)>>7<<b),!e&&a.enable?(a.countUp?a.nextEvent=0:(a.lastEvent=this.cpu.cycles,a.nextEvent=this.cpu.cycles+a.overflowInterval),this.io.registers[this.io.TM0CNT_LO+(b<<2)>>1]=a.reload,a.oldReload=a.reload,++this.timersEnabled):e&&!a.enable?(a.countUp||(this.io.registers[this.io.TM0CNT_LO+(b<<2)>>1]=a.oldReload+(this.cpu.cycles-a.lastEvent)>>d),--this.timersEnabled):a.prescaleBits!=d&&!a.countUp&&(a.nextEvent=a.lastEvent+a.overflowInterval),this.pollNextEvent()}timerRead(b){var a=this.timers[b];return a.enable&&!a.countUp?a.oldReload+(this.cpu.cycles-a.lastEvent)>>a.prescaleBits:this.io.registers[this.io.TM0CNT_LO+(b<<2)>>1]}halt(){if(!this.enable)throw'Requested HALT when interrupts were disabled!';if(!this.waitForIRQ())throw'Waiting on interrupt forever.'}lz77(l,m,i){for(var e=(this.cpu.mmu.load32(l)&4294967040)>>8,d=l+4,a=m,h=0,b=0,f,j,k,g,c;e>0;)if(h){if(g&128)for(f=this.cpu.mmu.loadU8(d)|this.cpu.mmu.loadU8(d+1)<<8,d+=2,j=a-((f&15)<<8|(f&65280)>>8)-1,k=((f&240)>>4)+3;k--&&e;)c=this.cpu.mmu.loadU8(j++),i==2?(b>>=8,b|=c<<8,a&1&&this.cpu.mmu.store16(a-1,b)):this.cpu.mmu.store8(a,c),--e,++a;else c=this.cpu.mmu.loadU8(d++),i==2?(b>>=8,b|=c<<8,a&1&&this.cpu.mmu.store16(a-1,b)):this.cpu.mmu.store8(a,c),--e,++a;g<<=1,--h}else g=this.cpu.mmu.loadU8(d++),h=8}huffman(d,s){var o,g,i,r,b,n,e,m,l,h,a,c,k,j,f,p,q;if(d=d&4294967292,o=this.cpu.mmu.load32(d),g=o>>8,i=o&15,32%i)throw'Unimplemented unaligned Huffman';r=4-g&3,g&=4294967292,b=[],n=(this.cpu.mmu.loadU8(d+4)<<1)+1,m=d+5+n,l=s&4294967292;for(h=0;h<n;++h)b.push(this.cpu.mmu.loadU8(d+5+h));for(c=0,f=0,a=b[0];g>0;){p=this.cpu.mmu.load32(m),m+=4;for(k=32;k>0;--k,p<<=1){if(typeof a=='number'&&(q=(c-1|1)+((a&63)<<1)+2,a={l:q,r:q+1,lTerm:a&128,rTerm:a&64},b[c]=a),p&2147483648)if(a.rTerm)j=b[a.r];else{c=a.r,a=b[a.r];continue}else if(a.lTerm)j=b[a.l];else{c=a.l,a=b[c];continue}e|=(j&(1<<i)-1)<<f,f+=i,c=0,a=b[0],f==32&&(f=0,this.cpu.mmu.store32(l,e),l+=4,g-=4,e=0)}}r&&this.cpu.mmu.store32(l,e)}rl(g,j,i){var d,h,b,c,f,a,e;for(g=g&4294967292,d=(this.cpu.mmu.load32(g)&4294967040)>>8,h=4-d&3,f=g+4,a=j,e=0;d>0;)if(b=this.cpu.mmu.loadU8(f++),b&128)for(b&=127,b+=3,c=this.cpu.mmu.loadU8(f++);b--&&d;)--d,i==2?(e>>=8,e|=c<<8,a&1&&this.cpu.mmu.store16(a-1,e)):this.cpu.mmu.store8(a,c),++a;else for(b++;b--&&d;)--d,c=this.cpu.mmu.loadU8(f++),i==2?(e>>=8,e|=c<<8,a&1&&this.cpu.mmu.store16(a-1,e)):this.cpu.mmu.store8(a,c),++a;while(h--)this.cpu.mmu.store8(a++,0)}}