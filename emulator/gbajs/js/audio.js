class GameBoyAdvanceAudio{constructor(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext){var a=this;this.context=new AudioContext,this.bufferSize=0,this.bufferSize=4096,this.maxSamples=this.bufferSize<<2,this.buffers=[new Float32Array(this.maxSamples),new Float32Array(this.maxSamples)],this.sampleMask=this.maxSamples-1,this.context.createScriptProcessor?this.jsAudio=this.context.createScriptProcessor(this.bufferSize):this.jsAudio=this.context.createJavaScriptNode(this.bufferSize),this.jsAudio.onaudioprocess=function(b){a.audioProcess(b)}}else this.context=null;this.masterEnable=!0,this.masterVolume=.1,this.SOUND_MAX=1024,this.FIFO_MAX=512,this.PSG_MAX=128}clear(){if(this.fifoA=[],this.fifoB=[],this.fifoASample=0,this.fifoBSample=0,this.enabled=!1,this.context)try{this.jsAudio.disconnect(this.context.destination)}catch(a){}this.enableChannel3=!1,this.enableChannel4=!1,this.enableChannelA=!1,this.enableChannelB=!1,this.enableRightChannelA=!1,this.enableLeftChannelA=!1,this.enableRightChannelB=!1,this.enableLeftChannelB=!1,this.playingChannel3=!1,this.playingChannel4=!1,this.volumeLeft=0,this.volumeRight=0,this.ratioChannelA=1,this.ratioChannelB=1,this.enabledLeft=0,this.enabledRight=0,this.dmaA=-1,this.dmaB=-1,this.soundTimerA=0,this.soundTimerB=0,this.soundRatio=1,this.soundBias=512,this.squareChannels=new Array;for(var a=0;a<2;++a)this.squareChannels[a]={enabled:!1,playing:!1,sample:0,duty:.5,increment:0,step:0,initialVolume:0,volume:0,frequency:0,interval:0,sweepSteps:0,sweepIncrement:0,sweepInterval:0,doSweep:!1,raise:0,lower:0,nextStep:0,timed:!1,length:0,end:0};this.waveData=new Uint8Array(32),this.channel3Dimension=0,this.channel3Bank=0,this.channel3Volume=0,this.channel3Interval=0,this.channel3Next=0,this.channel3Length=0,this.channel3Timed=!1,this.channel3End=0,this.channel3Pointer=0,this.channel3Sample=0,this.cpuFrequency=this.core.irq.FREQUENCY,this.channel4={sample:0,lfsr:0,width:15,interval:this.cpuFrequency/524288,increment:0,step:0,initialVolume:0,volume:0,nextStep:0,timed:!1,length:0,end:0},this.nextEvent=0,this.nextSample=0,this.outputPointer=0,this.samplePointer=0,this.backup=0,this.totalSamples=0,this.sampleRate=32768,this.sampleInterval=this.cpuFrequency/this.sampleRate,this.resampleRatio=1,this.context&&(this.resampleRatio=this.sampleRate/this.context.sampleRate),this.writeSquareChannelFC(0,0),this.writeSquareChannelFC(1,0),this.writeChannel4FC(0)}freeze(){return{nextSample:this.nextSample}}defrost(a){this.nextSample=a.nextSample}pause(a){if(this.context)if(a)try{this.jsAudio.disconnect(this.context.destination)}catch(a){}else this.enabled&&this.jsAudio.connect(this.context.destination)}updateTimers(){var a=this.cpu.cycles,b,c;if(!this.enabled||a<this.nextEvent&&a<this.nextSample)return;a>=this.nextEvent&&(b=this.squareChannels[0],this.nextEvent=1/0,b.playing&&this.updateSquareChannel(b,a),b=this.squareChannels[1],b.playing&&this.updateSquareChannel(b,a),this.enableChannel3&&this.playingChannel3&&(a>=this.channel3Next&&(this.channel3Write&&(c=this.waveData[this.channel3Pointer>>1],this.channel3Sample=((c>>((this.channel3Pointer&1)<<2)&15)-8)/8,this.channel3Pointer=this.channel3Pointer+1,this.channel3Dimension&&this.channel3Pointer>=64?this.channel3Pointer-=64:!this.channel3Bank&&this.channel3Pointer>=32?this.channel3Pointer-=32:this.channel3Pointer>=64&&(this.channel3Pointer-=32)),this.channel3Next+=this.channel3Interval,this.channel3Interval&&this.nextEvent>this.channel3Next&&(this.nextEvent=this.channel3Next)),this.channel3Timed&&a>=this.channel3End&&(this.playingChannel3=!1)),this.enableChannel4&&this.playingChannel4&&(this.channel4.timed&&a>=this.channel4.end?this.playingChannel4=!1:(a>=this.channel4.next&&(this.channel4.lfsr>>=1,c=this.channel4.lfsr&1,this.channel4.lfsr|=(this.channel4.lfsr>>1&1^c)<<this.channel4.width-1,this.channel4.next+=this.channel4.interval,this.channel4.sample=(c-.5)*2*this.channel4.volume),this.updateEnvelope(this.channel4,a),this.nextEvent>this.channel4.next&&(this.nextEvent=this.channel4.next),this.channel4.timed&&this.nextEvent>this.channel4.end&&(this.nextEvent=this.channel4.end)))),a>=this.nextSample&&(this.sample(),this.nextSample+=this.sampleInterval),this.nextEvent=Math.ceil(this.nextEvent),(this.nextEvent<a||this.nextSample<a)&&this.updateTimers()}writeEnable(a){if(this.enabled=!!a,this.nextEvent=this.cpu.cycles,this.nextSample=this.nextEvent,this.updateTimers(),this.core.irq.pollNextEvent(),this.context)if(a)this.jsAudio.connect(this.context.destination);else try{this.jsAudio.disconnect(this.context.destination)}catch(a){}}writeSoundControlLo(a){this.masterVolumeLeft=a&7,this.masterVolumeRight=a>>4&7,this.enabledLeft=a>>8&15,this.enabledRight=a>>12&15,this.setSquareChannelEnabled(this.squareChannels[0],(this.enabledLeft|this.enabledRight)&1),this.setSquareChannelEnabled(this.squareChannels[1],(this.enabledLeft|this.enabledRight)&2),this.enableChannel3=(this.enabledLeft|this.enabledRight)&4,this.setChannel4Enabled((this.enabledLeft|this.enabledRight)&8),this.updateTimers(),this.core.irq.pollNextEvent()}writeSoundControlHi(a){switch(a&3){case 0:this.soundRatio=.25;break;case 1:this.soundRatio=.5;break;case 2:this.soundRatio=1;break}this.ratioChannelA=(((a&4)>>2)+1)*.5,this.ratioChannelB=(((a&8)>>3)+1)*.5,this.enableRightChannelA=a&256,this.enableLeftChannelA=a&512,this.enableChannelA=a&768,this.soundTimerA=a&1024,a&2048&&(this.fifoA=[]),this.enableRightChannelB=a&4096,this.enableLeftChannelB=a&8192,this.enableChannelB=a&12288,this.soundTimerB=a&16384,a&32768&&(this.fifoB=[])}resetSquareChannel(a){a.step&&(a.nextStep=this.cpu.cycles+a.step),a.enabled&&!a.playing&&(a.raise=this.cpu.cycles,a.lower=a.raise+a.duty*a.interval,a.end=this.cpu.cycles+a.length,this.nextEvent=this.cpu.cycles),a.playing=a.enabled,this.updateTimers(),this.core.irq.pollNextEvent()}setSquareChannelEnabled(a,b){!(a.enabled&&a.playing)&&b?(a.enabled=!!b,this.updateTimers(),this.core.irq.pollNextEvent()):a.enabled=!!b}writeSquareChannelSweep(c,b){var a=this.squareChannels[c];a.sweepSteps=b&7,a.sweepIncrement=b&8?-1:1,a.sweepInterval=(b>>4&7)*this.cpuFrequency/128,a.doSweep=!!a.sweepInterval,a.nextSweep=this.cpu.cycles+a.sweepInterval,this.resetSquareChannel(a)}writeSquareChannelDLE(c,b){var a=this.squareChannels[c],d=b>>6&3;switch(d){case 0:a.duty=.125;break;case 1:a.duty=.25;break;case 2:a.duty=.5;break;case 3:a.duty=.75;break}this.writeChannelLE(a,b),this.resetSquareChannel(a)}writeSquareChannelFC(d,b){var a=this.squareChannels[d],c=b&2047;a.frequency=c,a.interval=this.cpuFrequency*(2048-c)/131072,a.timed=!!(b&16384),b&32768&&(this.resetSquareChannel(a),a.volume=a.initialVolume)}updateSquareChannel(a,b){if(a.timed&&b>=a.end){a.playing=!1;return}if(a.doSweep&&b>=a.nextSweep){if(a.frequency+=a.sweepIncrement*(a.frequency>>a.sweepSteps),a.frequency<0)a.frequency=0;else if(a.frequency>2047){a.frequency=2047,a.playing=!1;return}a.interval=this.cpuFrequency*(2048-a.frequency)/131072,a.nextSweep+=a.sweepInterval}b>=a.raise?(a.sample=a.volume,a.lower=a.raise+a.duty*a.interval,a.raise+=a.interval):b>=a.lower&&(a.sample=-a.volume,a.lower+=a.interval),this.updateEnvelope(a,b),this.nextEvent>a.raise&&(this.nextEvent=a.raise),this.nextEvent>a.lower&&(this.nextEvent=a.lower),a.timed&&this.nextEvent>a.end&&(this.nextEvent=a.end),a.doSweep&&this.nextEvent>a.nextSweep&&(this.nextEvent=a.nextSweep)}writeChannel3Lo(a){this.channel3Dimension=a&32,this.channel3Bank=a&64;var b=a&128;!this.channel3Write&&b?(this.channel3Write=b,this.resetChannel3()):this.channel3Write=b}writeChannel3Hi(a){this.channel3Length=this.cpuFrequency*(256-(a&255))/256;var b=a>>13&7;switch(b){case 0:this.channel3Volume=0;break;case 1:this.channel3Volume=1;break;case 2:this.channel3Volume=.5;break;case 3:this.channel3Volume=.25;break;default:this.channel3Volume=.75}}writeChannel3X(a){this.channel3Interval=this.cpuFrequency*(2048-(a&2047))/2097152,this.channel3Timed=!!(a&16384),this.channel3Write&&this.resetChannel3()}resetChannel3(){this.channel3Next=this.cpu.cycles,this.nextEvent=this.channel3Next,this.channel3End=this.cpu.cycles+this.channel3Length,this.playingChannel3=this.channel3Write,this.updateTimers(),this.core.irq.pollNextEvent()}writeWaveData(a,b,c){this.channel3Bank||(a+=16),c==2&&(this.waveData[a]=b&255,b>>=8,++a),this.waveData[a]=b&255}setChannel4Enabled(a){!this.enableChannel4&&a?(this.channel4.next=this.cpu.cycles,this.channel4.end=this.cpu.cycles+this.channel4.length,this.enableChannel4=!0,this.playingChannel4=!0,this.nextEvent=this.cpu.cycles,this.updateEnvelope(this.channel4),this.updateTimers(),this.core.irq.pollNextEvent()):this.enableChannel4=a}writeChannel4LE(a){this.writeChannelLE(this.channel4,a),this.resetChannel4()}writeChannel4FC(a){var b,e,c,d;this.channel4.timed=!!(a&16384),b=a&7,b||(b=.5),e=a>>4&15,c=this.cpuFrequency*(b*(2<<e))/524288,c!=this.channel4.interval&&(this.channel4.interval=c,this.resetChannel4()),d=a&8?7:15,d!=this.channel4.width&&(this.channel4.width=d,this.resetChannel4()),a&32768&&this.resetChannel4()}resetChannel4(){this.channel4.width==15?this.channel4.lfsr=16384:this.channel4.lfsr=64,this.channel4.volume=this.channel4.initialVolume,this.channel4.step&&(this.channel4.nextStep=this.cpu.cycles+this.channel4.step),this.channel4.end=this.cpu.cycles+this.channel4.length,this.channel4.next=this.cpu.cycles,this.nextEvent=this.channel4.next,this.playingChannel4=this.enableChannel4,this.updateTimers(),this.core.irq.pollNextEvent()}writeChannelLE(a,b){a.length=this.cpuFrequency*((64-(b&63))/256),b&2048?a.increment=1/16:a.increment=-1/16,a.initialVolume=(b>>12&15)/16,a.step=this.cpuFrequency*((b>>8&7)/64)}updateEnvelope(a,b){a.step&&(b>=a.nextStep&&(a.volume+=a.increment,a.volume>1?a.volume=1:a.volume<0&&(a.volume=0),a.nextStep+=a.step),this.nextEvent>a.nextStep&&(this.nextEvent=a.nextStep))}appendToFifoA(a){var b,c;this.fifoA.length>28&&(this.fifoA=this.fifoA.slice(-28));for(c=0;c<4;++c)b=(a&255)<<24,a>>=8,this.fifoA.push(b/2147483648)}appendToFifoB(a){var b,c;this.fifoB.length>28&&(this.fifoB=this.fifoB.slice(-28));for(c=0;c<4;++c)b=(a&255)<<24,a>>=8,this.fifoB.push(b/2147483648)}sampleFifoA(){if(this.fifoA.length<=16){var a=this.core.irq.dma[this.dmaA];a.nextCount=4,this.core.mmu.serviceDma(this.dmaA,a)}this.fifoASample=this.fifoA.shift()}sampleFifoB(){if(this.fifoB.length<=16){var a=this.core.irq.dma[this.dmaB];a.nextCount=4,this.core.mmu.serviceDma(this.dmaB,a)}this.fifoBSample=this.fifoB.shift()}scheduleFIFODma(b,a){switch(a.dest){case this.cpu.mmu.BASE_IO|this.cpu.irq.io.FIFO_A_LO:a.dstControl=2,this.dmaA=b;break;case this.cpu.mmu.BASE_IO|this.cpu.irq.io.FIFO_B_LO:a.dstControl=2,this.dmaB=b;break;default:this.core.WARN('Tried to schedule FIFO DMA for non-FIFO destination');break}}sample(){var b=0,c=0,d=this.squareChannels[0],a,e;d.playing&&(a=d.sample*this.soundRatio*this.PSG_MAX,this.enabledLeft&1&&(b+=a),this.enabledRight&1&&(c+=a)),d=this.squareChannels[1],d.playing&&(a=d.sample*this.soundRatio*this.PSG_MAX,this.enabledLeft&2&&(b+=a),this.enabledRight&2&&(c+=a)),this.playingChannel3&&(a=this.channel3Sample*this.soundRatio*this.channel3Volume*this.PSG_MAX,this.enabledLeft&4&&(b+=a),this.enabledRight&4&&(c+=a)),this.playingChannel4&&(a=this.channel4.sample*this.soundRatio*this.PSG_MAX,this.enabledLeft&8&&(b+=a),this.enabledRight&8&&(c+=a)),this.enableChannelA&&(a=this.fifoASample*this.FIFO_MAX*this.ratioChannelA,this.enableLeftChannelA&&(b+=a),this.enableRightChannelA&&(c+=a)),this.enableChannelB&&(a=this.fifoBSample*this.FIFO_MAX*this.ratioChannelB,this.enableLeftChannelB&&(b+=a),this.enableRightChannelB&&(c+=a)),e=this.samplePointer,b*=this.masterVolume/this.SOUND_MAX,b=Math.max(Math.min(b,1),-1),c*=this.masterVolume/this.SOUND_MAX,c=Math.max(Math.min(c,1),-1),this.buffers&&(this.buffers[0][e]=b,this.buffers[1][e]=c),this.samplePointer=e+1&this.sampleMask}audioProcess(e){var c=e.outputBuffer.getChannelData(0),d=e.outputBuffer.getChannelData(1),a,b;if(this.masterEnable){b=this.outputPointer;for(a=0;a<this.bufferSize;++a,b+=this.resampleRatio){if(b>=this.maxSamples&&(b-=this.maxSamples),(b|0)==this.samplePointer){++this.backup;break}c[a]=this.buffers[0][b|0],d[a]=this.buffers[1][b|0]}for(;a<this.bufferSize;++a)c[a]=0,d[a]=0;this.outputPointer=b,++this.totalSamples}else for(a=0;a<this.bufferSize;++a)c[a]=0,d[a]=0}}