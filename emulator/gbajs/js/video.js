class GameBoyAdvanceVideo{constructor(){try{this.renderPath=new GameBoyAdvanceRenderProxy}catch(a){console.log("Service worker renderer couldn't load. Save states (not save files) may be glitchy"),this.renderPath=new GameBoyAdvanceSoftwareRenderer}this.CYCLES_PER_PIXEL=4,this.HORIZONTAL_PIXELS=240,this.HBLANK_PIXELS=68,this.HDRAW_LENGTH=1006,this.HBLANK_LENGTH=226,this.HORIZONTAL_LENGTH=1232,this.VERTICAL_PIXELS=160,this.VBLANK_PIXELS=68,this.VERTICAL_TOTAL_PIXELS=228,this.TOTAL_LENGTH=280896,this.drawCallback=function(){},this.vblankCallback=function(){}}clear(){this.renderPath.clear(this.cpu.mmu),this.DISPSTAT_MASK=65336,this.inHblank=!1,this.inVblank=!1,this.vcounter=0,this.vblankIRQ=0,this.hblankIRQ=0,this.vcounterIRQ=0,this.vcountSetting=0,this.vcount=-1,this.lastHblank=0,this.nextHblank=this.HDRAW_LENGTH,this.nextEvent=this.nextHblank,this.nextHblankIRQ=0,this.nextVblankIRQ=0,this.nextVcounterIRQ=0}freeze(){return{inHblank:this.inHblank,inVblank:this.inVblank,vcounter:this.vcounter,vblankIRQ:this.vblankIRQ,hblankIRQ:this.hblankIRQ,vcounterIRQ:this.vcounterIRQ,vcountSetting:this.vcountSetting,vcount:this.vcount,lastHblank:this.lastHblank,nextHblank:this.nextHblank,nextEvent:this.nextEvent,nextHblankIRQ:this.nextHblankIRQ,nextVblankIRQ:this.nextVblankIRQ,nextVcounterIRQ:this.nextVcounterIRQ,renderPath:this.renderPath.freeze(this.core.encodeBase64)}}defrost(a){this.inHblank=a.inHblank,this.inVblank=a.inVblank,this.vcounter=a.vcounter,this.vblankIRQ=a.vblankIRQ,this.hblankIRQ=a.hblankIRQ,this.vcounterIRQ=a.vcounterIRQ,this.vcountSetting=a.vcountSetting,this.vcount=a.vcount,this.lastHblank=a.lastHblank,this.nextHblank=a.nextHblank,this.nextEvent=a.nextEvent,this.nextHblankIRQ=a.nextHblankIRQ,this.nextVblankIRQ=a.nextVblankIRQ,this.nextVcounterIRQ=a.nextVcounterIRQ,this.renderPath.defrost(a.renderPath,this.core.decodeBase64)}setBacking(c){var a=c.createImageData(this.HORIZONTAL_PIXELS,this.VERTICAL_PIXELS),b;this.context=c;for(b=0;b<this.HORIZONTAL_PIXELS*this.VERTICAL_PIXELS*4;)a.data[b++]=255,a.data[b++]=255,a.data[b++]=255,a.data[b++]=255;this.renderPath.setBacking(a)}updateTimers(a){var b=a.cycles;if(this.nextEvent<=b)if(this.inHblank){switch(this.inHblank=!1,this.nextEvent=this.nextHblank,++this.vcount,this.vcount){case this.VERTICAL_PIXELS:this.inVblank=!0,this.renderPath.finishDraw(this),this.nextVblankIRQ=this.nextEvent+this.TOTAL_LENGTH,this.cpu.mmu.runVblankDmas(),this.vblankIRQ&&this.cpu.irq.raiseIRQ(this.cpu.irq.IRQ_VBLANK),this.vblankCallback();break;case this.VERTICAL_TOTAL_PIXELS-1:this.inVblank=!1;break;case this.VERTICAL_TOTAL_PIXELS:this.vcount=0,this.renderPath.startDraw();break}this.vcounter=this.vcount==this.vcountSetting,this.vcounter&&this.vcounterIRQ&&(this.cpu.irq.raiseIRQ(this.cpu.irq.IRQ_VCOUNTER),this.nextVcounterIRQ+=this.TOTAL_LENGTH),this.vcount<this.VERTICAL_PIXELS&&this.renderPath.drawScanline(this.vcount)}else this.inHblank=!0,this.lastHblank=this.nextHblank,this.nextEvent=this.lastHblank+this.HBLANK_LENGTH,this.nextHblank=this.nextEvent+this.HDRAW_LENGTH,this.nextHblankIRQ=this.nextHblank,this.vcount<this.VERTICAL_PIXELS&&this.cpu.mmu.runHblankDmas(),this.hblankIRQ&&this.cpu.irq.raiseIRQ(this.cpu.irq.IRQ_HBLANK)}writeDisplayStat(a){this.vblankIRQ=a&8,this.hblankIRQ=a&16,this.vcounterIRQ=a&32,this.vcountSetting=(a&65280)>>8,this.vcounterIRQ&&(this.nextVcounterIRQ=this.nextHblank+this.HBLANK_LENGTH+(this.vcountSetting-this.vcount)*this.HORIZONTAL_LENGTH,this.nextVcounterIRQ<this.nextEvent&&(this.nextVcounterIRQ+=this.TOTAL_LENGTH))}readDisplayStat(){return this.inVblank|this.inHblank<<1|this.vcounter<<2}finishDraw(a){this.context.putImageData(a,0,0),this.drawCallback()}}