function hex(d,a,b){typeof b=='undefined'&&(b=!0),typeof a=='undefined'&&(a=8);var c=(d>>>0).toString(16).toUpperCase();return a-=c.length,a<0?c:(b?'0x':'')+new Array(a+1).join('0')+c}class Pointer{constructor(){this.index=0,this.top=0,this.stack=[]}advance(a){var b=this.index;return this.index+=a,b}mark(){return this.index-this.top}push(){this.stack.push(this.top),this.top=this.index}pop(){this.top=this.stack.pop()}readString(a){for(var d=a.getUint32(this.advance(4),!0),b=[],c=0;c<d;++c)b.push(String.fromCharCode(a.getUint8(this.advance(1))));return b.join('')}}class Serializer{TAG_INT=1;TAG_STRING=2;TAG_STRUCT=3;TAG_BLOB=4;TAG_BOOLEAN=5;TYPE='application/octet-stream';pack(b){var a=new DataView(new ArrayBuffer(4));return a.setUint32(0,b,!0),a.buffer}pack8(b){var a=new DataView(new ArrayBuffer(1));return a.setUint8(0,b,!0),a.buffer}prefix(a){return new Blob([Serializer.pack(a.size||a.length||a.byteLength),a],{type:Serializer.TYPE})}serialize(a){var d=[],e=4,c,f,b;for(i in a)if(a.hasOwnProperty(i)){switch(f=Serializer.prefix(i),typeof a[i]){case'number':c=Serializer.TAG_INT,b=Serializer.pack(a[i]);break;case'string':c=Serializer.TAG_STRING,b=Serializer.prefix(a[i]);break;case'object':a[i].type==Serializer.TYPE?(c=Serializer.TAG_BLOB,b=a[i]):(c=Serializer.TAG_STRUCT,b=Serializer.serialize(a[i]));break;case'boolean':c=Serializer.TAG_BOOLEAN,b=Serializer.pack8(a[i]);break;default:console.log(a[i]);break}e+=1+f.size+(b.size||b.byteLength||b.length),d.push(Serializer.pack8(c)),d.push(f),d.push(b)}return d.unshift(Serializer.pack(e)),new Blob(d)}deserialize(b,c){var a=new FileReader;a.onload=function(a){c(Serializer.deserealizeStream(new DataView(a.target.result),new Pointer))},a.readAsArrayBuffer(b)}deserealizeStream(b,a){var d,e,f,g,c,h;for(a.push(),d={},e=b.getUint32(a.advance(4),!0);a.mark()<e;){switch(f=b.getUint8(a.advance(1)),g=a.readString(b),f){case Serializer.TAG_INT:c=b.getUint32(a.advance(4),!0);break;case Serializer.TAG_STRING:c=a.readString(b);break;case Serializer.TAG_STRUCT:c=Serializer.deserealizeStream(b,a);break;case Serializer.TAG_BLOB:h=b.getUint32(a.advance(4),!0),c=b.buffer.slice(a.advance(h),a.advance(0));break;case Serializer.TAG_BOOLEAN:c=!!b.getUint8(a.advance(1));break}d[g]=c}if(a.mark()>e)throw'Size of serialized data exceeded';return a.pop(),d}serializePNG(h,a,m){for(var c=document.createElement('canvas'),i=c.getContext('2d'),d=a.getContext('2d').getImageData(0,0,a.width,a.height),g=0,e=0,f,j,b,n,k,l;e<a.height;++e)for(f=0;f<a.width;++f)d.data[(f+e*a.width)*4+3]||++g;j=g*3+(a.width*a.height-g);for(b=1;j*b*b<h.size;++b);return n=j*b*b-h.size,k=Math.ceil(n/(a.width*b)),c.setAttribute('width',a.width*b),c.setAttribute('height',a.height*b+k),l=new FileReader,l.onload=function(q){for(var j=new Uint8Array(q.target.result),l=0,f=0,e=i.createImageData(c.width,c.height+k),o=0,n,g,h,p;o<c.height;++o)for(n=0;n<c.width;++n)g=o/b|0,h=n/b|0,g>a.height||!d.data[(h+g*a.width)*4+3]?(e.data[f++]=j[l++],e.data[f++]=j[l++],e.data[f++]=j[l++],e.data[f++]=0):(p=j[l++],e.data[f++]=d.data[(h+g*a.width)*4+0]|p&7,e.data[f++]=d.data[(h+g*a.width)*4+1]|p>>3&7,e.data[f++]=d.data[(h+g*a.width)*4+2]|p>>6&7,e.data[f++]=d.data[(h+g*a.width)*4+3]);i.putImageData(e,0,0),m(c.toDataURL('image/png'))},l.readAsArrayBuffer(h),c}deserializePNG(b,c){var a=new FileReader;a.onload=function(f){var g=document.createElement('img'),a,i,e,d,b,h;g.setAttribute('src',f.target.result),a=document.createElement('canvas'),a.setAttribute('height',g.height),a.setAttribute('width',g.width),i=a.getContext('2d'),i.drawImage(g,0,0),e=i.getImageData(0,0,a.width,a.height),f=[];for(d=0;d<a.height;++d)for(b=0;b<a.width;++b)e.data[(b+d*a.width)*4+3]?(h=0,h|=e.data[(b+d*a.width)*4+0]&7,h|=(e.data[(b+d*a.width)*4+1]&7)<<3,h|=(e.data[(b+d*a.width)*4+2]&7)<<6,f.push(h)):(f.push(e.data[(b+d*a.width)*4+0]),f.push(e.data[(b+d*a.width)*4+1]),f.push(e.data[(b+d*a.width)*4+2]));newBlob=new Blob(f.map(function(b){var a=new Uint8Array(1);return a[0]=b,a}),{type:Serializer.TYPE}),Serializer.deserialize(newBlob,c)},a.readAsDataURL(b)}}