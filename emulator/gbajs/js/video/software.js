class MemoryAligned16{constructor(a){this.buffer=new Uint16Array(a>>1)}load8(a){return this.loadU8(a)<<24>>24}load16(a){return this.loadU16(a)<<16>>16}loadU8(a){var b=a>>1;return a&1?(this.buffer[b]&65280)>>>8:this.buffer[b]&255}loadU16(a){return this.buffer[a>>1]}load32(a){return this.buffer[a>>1&~1]|this.buffer[a>>1|1]<<16}store8(a,b){var c=a>>1;this.store16(a,b<<8|b)}store16(a,b){this.buffer[a>>1]=b}store32(a,b){var c=a>>1;this.store16(a,this.buffer[c]=b&65535),this.store16(a+2,this.buffer[c+1]=b>>>16)}insert(a,b){this.buffer.set(b,a)}invalidatePage(a){}}class GameBoyAdvanceVRAM extends MemoryAligned16{constructor(a){super(a),this.vram=this.buffer}}class GameBoyAdvanceOAM extends MemoryAligned16{constructor(b){var a;super(b),this.oam=this.buffer,this.objs=new Array(128);for(a=0;a<128;++a)this.objs[a]=new GameBoyAdvanceOBJ(this,a);this.scalerot=new Array(32);for(a=0;a<32;++a)this.scalerot[a]={a:1,b:0,c:0,d:1}}overwrite(b){for(var a=0;a<this.buffer.byteLength>>1;++a)this.store16(a<<1,b[a])}store16(d,b){var e=(d&1016)>>3,a=this.objs[e],c=this.scalerot[e>>2],g=a.priority,h=a.disable,i=a.y,f;switch(d&6){case 0:a.y=b&255,f=a.scalerot,a.scalerot=b&256,a.scalerot?(a.scalerotOam=this.scalerot[a.scalerotParam],a.doublesize=!!(b&512),a.disable=0,a.hflip=0,a.vflip=0):(a.doublesize=!1,a.disable=b&512,f&&(a.hflip=a.scalerotParam&8,a.vflip=a.scalerotParam&16)),a.mode=(b&3072)>>6,a.mosaic=b&4096,a.multipalette=b&8192,a.shape=(b&49152)>>14,a.recalcSize();break;case 2:a.x=b&511,a.scalerot?(a.scalerotParam=(b&15872)>>9,a.scalerotOam=this.scalerot[a.scalerotParam],a.hflip=0,a.vflip=0,a.drawScanline=a.drawScanlineAffine):(a.hflip=b&4096,a.vflip=b&8192,a.drawScanline=a.drawScanlineNormal),a.size=(b&49152)>>14,a.recalcSize();break;case 4:a.tileBase=b&1023,a.priority=(b&3072)>>10,a.palette=(b&61440)>>8;break;case 6:switch(e&3){case 0:c.a=(b<<16)/16777216;break;case 1:c.b=(b<<16)/16777216;break;case 2:c.c=(b<<16)/16777216;break;case 3:c.d=(b<<16)/16777216;break}break}MemoryAligned16.prototype.store16.call(this,d,b)}}GameBoyAdvanceOAM.prototype=Object.create(MemoryAligned16.prototype);class GameBoyAdvancePalette{constructor(){this.colors=[new Array(256),new Array(256)],this.adjustedColors=[new Array(256),new Array(256)],this.passthroughColors=[this.colors[0],this.colors[0],this.colors[0],this.colors[0],this.colors[1],this.colors[0]],this.blendY=1}overwrite(b){for(var a=0;a<512;++a)this.store16(a<<1,b[a])}loadU8(a){return this.loadU16(a)>>8*(a&1)&255}loadU16(a){return this.colors[(a&512)>>9][(a&511)>>1]}load16(a){return this.loadU16(a)<<16>>16}load32(a){return this.loadU16(a)|this.loadU16(a+2)<<16}store16(a,b){var c=(a&512)>>9,d=(a&511)>>1;this.colors[c][d]=b,this.adjustedColors[c][d]=this.adjustColor(b)}store32(a,b){this.store16(a,b&65535),this.store16(a+2,b>>16)}invalidatePage(a){}convert16To32(a,b){var c=(a&31)<<3,d=(a&992)>>2,e=(a&31744)>>7;b[0]=c,b[1]=d,b[2]=e}mix(a,b,c,d){var g=b&31,f=(b&992)>>5,e=(b&31744)>>10,h=d&31,i=(d&992)>>5,j=(d&31744)>>10,k=Math.min(a*g+c*h,31),l=Math.min(a*f+c*i,31),m=Math.min(a*e+c*j,31);return k|l<<5|m<<10}makeDarkPalettes(a){this.adjustColor!=this.adjustColorDark&&(this.adjustColor=this.adjustColorDark,this.resetPalettes()),this.resetPaletteLayers(a)}makeBrightPalettes(a){this.adjustColor!=this.adjustColorBright&&(this.adjustColor=this.adjustColorBright,this.resetPalettes()),this.resetPaletteLayers(a)}makeNormalPalettes(){this.passthroughColors[0]=this.colors[0],this.passthroughColors[1]=this.colors[0],this.passthroughColors[2]=this.colors[0],this.passthroughColors[3]=this.colors[0],this.passthroughColors[4]=this.colors[1],this.passthroughColors[5]=this.colors[0]}makeSpecialPalette(a){this.passthroughColors[a]=this.adjustedColors[a==4?1:0]}makeNormalPalette(a){this.passthroughColors[a]=this.colors[a==4?1:0]}resetPaletteLayers(a){a&1?this.passthroughColors[0]=this.adjustedColors[0]:this.passthroughColors[0]=this.colors[0],a&2?this.passthroughColors[1]=this.adjustedColors[0]:this.passthroughColors[1]=this.colors[0],a&4?this.passthroughColors[2]=this.adjustedColors[0]:this.passthroughColors[2]=this.colors[0],a&8?this.passthroughColors[3]=this.adjustedColors[0]:this.passthroughColors[3]=this.colors[0],a&16?this.passthroughColors[4]=this.adjustedColors[1]:this.passthroughColors[4]=this.colors[1],a&32?this.passthroughColors[5]=this.adjustedColors[0]:this.passthroughColors[5]=this.colors[0]}resetPalettes(){var b=this.adjustedColors[0],c=this.colors[0],a;for(a=0;a<256;++a)b[a]=this.adjustColor(c[a]);b=this.adjustedColors[1],c=this.colors[1];for(a=0;a<256;++a)b[a]=this.adjustColor(c[a])}accessColor(a,b){return this.passthroughColors[a][b]}adjustColorDark(d){var a=d&31,b=(d&992)>>5,c=(d&31744)>>10;return a=a-a*this.blendY,b=b-b*this.blendY,c=c-c*this.blendY,a|b<<5|c<<10}adjustColorBright(d){var a=d&31,b=(d&992)>>5,c=(d&31744)>>10;return a=a+(31-a)*this.blendY,b=b+(31-b)*this.blendY,c=c+(31-c)*this.blendY,a|b<<5|c<<10}setBlendY(a){this.blendY!=a&&(this.blendY=a,this.resetPalettes())}}GameBoyAdvancePalette.prototype.adjustColor=GameBoyAdvancePalette.prototype.adjustColorBright;class GameBoyAdvanceOBJ{constructor(a,b){this.TILE_OFFSET=65536,this.oam=a,this.index=b,this.x=0,this.y=0,this.scalerot=0,this.doublesize=!1,this.disable=1,this.mode=0,this.mosaic=!1,this.multipalette=!1,this.shape=0,this.scalerotParam=0,this.hflip=0,this.vflip=0,this.tileBase=0,this.priority=0,this.palette=0,this.drawScanline=this.drawScanlineNormal,this.pushPixel=GameBoyAdvanceSoftwareRenderer.pushPixel,this.cachedWidth=8,this.cachedHeight=8}drawScanlineNormal(r,q,p,j,k){var a=this.oam.video,o=this.mode|a.target2[a.LAYER_OBJ]|this.priority<<1,c,d,f,m,b,h,n,e,i,g,l;this.mode==16&&(o|=a.TARGET1_MASK),a.blendMode==1&&a.alphaEnabled&&(o|=a.target1[a.LAYER_OBJ]),m=this.cachedWidth,this.x<a.HORIZONTAL_PIXELS?(this.x<j?(c=j-this.x,d=j):(c=0,d=this.x),k<this.cachedWidth+this.x&&(m=k-this.x)):(c=j+512-this.x,d=j,k<this.cachedWidth-c&&(m=k)),this.vflip?h=this.cachedHeight-q+p-1:h=q-p,n=h&7,g=this.multipalette?1:0,a.objCharacterMapping?i=(h&504)*this.cachedWidth>>6:i=(h&504)<<2-g,this.mosaic&&(e=a.objMosaicX-1-(a.objMosaicX+d-1)%a.objMosaicX,d+=e,c+=e),this.hflip?b=this.cachedWidth-c-1:b=c,l=a.accessTile(this.TILE_OFFSET+(f&4)*g,this.tileBase+(i<<g)+((b&504)>>3-g),n<<g);for(f=c;f<m;++f)e=this.mosaic?d%a.objMosaicX:0,this.hflip?b=this.cachedWidth-(f-e)-1:b=f-e,g?(!(f&3)||this.mosaic&&!e)&&(l=a.accessTile(this.TILE_OFFSET+(b&4),this.tileBase+(i<<1)+((b&504)>>2),n<<1)):(!(f&7)||this.mosaic&&!e)&&(l=a.accessTile(this.TILE_OFFSET,this.tileBase+i+(b>>3),n)),this.pushPixel(a.LAYER_OBJ,this,a,l,b&7,d,r,o,!1),d++}drawScanlineAffine(q,n,r,i,j){var a=this.oam.video,l=this.mode|a.target2[a.LAYER_OBJ]|this.priority<<1,h,f,d,b,c,o,m,g,k,p,e,s;this.mode==16&&(l|=a.TARGET1_MASK),a.blendMode==1&&a.alphaEnabled&&(l|=a.target1[a.LAYER_OBJ]),o=n-r,g=this.multipalette?1:0,k=this.cachedWidth<<this.doublesize,p=this.cachedHeight<<this.doublesize,e=k,e>a.HORIZONTAL_PIXELS&&(k=a.HORIZONTAL_PIXELS),this.x<a.HORIZONTAL_PIXELS?(this.x<i?(h=i-this.x,f=i):(h=0,f=this.x),j<e+this.x&&(e=j-this.x)):(h=i+512-this.x,f=i,j<e-h&&(e=j));for(d=h;d<e;++d){if(b=this.scalerotOam.a*(d-(k>>1))+this.scalerotOam.b*(o-(p>>1))+(this.cachedWidth>>1),c=this.scalerotOam.c*(d-(k>>1))+this.scalerotOam.d*(o-(p>>1))+(this.cachedHeight>>1),this.mosaic&&(b-=d%a.objMosaicX*this.scalerotOam.a+n%a.objMosaicY*this.scalerotOam.b,c-=d%a.objMosaicX*this.scalerotOam.c+n%a.objMosaicY*this.scalerotOam.d),b<0||b>=this.cachedWidth||c<0||c>=this.cachedHeight){f++;continue}a.objCharacterMapping?m=(c&504)*this.cachedWidth>>6:m=(c&504)<<2-g,s=a.accessTile(this.TILE_OFFSET+(b&4)*g,this.tileBase+(m<<g)+((b&504)>>3-g),(c&7)<<g),this.pushPixel(a.LAYER_OBJ,this,a,s,b&7,f,q,l,!1),f++}}recalcSize(){switch(this.shape){case 0:this.cachedHeight=this.cachedWidth=8<<this.size;break;case 1:switch(this.size){case 0:this.cachedHeight=8,this.cachedWidth=16;break;case 1:this.cachedHeight=8,this.cachedWidth=32;break;case 2:this.cachedHeight=16,this.cachedWidth=32;break;case 3:this.cachedHeight=32,this.cachedWidth=64;break}break;case 2:switch(this.size){case 0:this.cachedHeight=16,this.cachedWidth=8;break;case 1:this.cachedHeight=32,this.cachedWidth=8;break;case 2:this.cachedHeight=32,this.cachedWidth=16;break;case 3:this.cachedHeight=64,this.cachedWidth=32;break}break;default:}}}class GameBoyAdvanceOBJLayer{constructor(a,b){this.video=a,this.bg=!1,this.index=a.LAYER_OBJ,this.priority=b,this.enabled=!1,this.objwin=0}drawScanline(j,k,g,i){var b=this.video.vcount,c,d,a,h,e,f;if(g>=i)return;h=this.video.oam.objs;for(e=0;e<h.length;++e){if(a=h[e],a.disable)continue;if((a.mode&this.video.OBJWIN_MASK)!=this.objwin)continue;if(!(a.mode&this.video.OBJWIN_MASK)&&this.priority!=a.priority)continue;a.y<this.video.VERTICAL_PIXELS?c=a.y:c=a.y-256,a.scalerot?f=a.cachedHeight<<a.doublesize:f=a.cachedHeight,a.mosaic?d=b-b%this.video.objMosaicY:d=b,c<=b&&c+f>b&&a.drawScanline(j,d,c,g,i)}}objComparator(a,b){return a.index-b.index}}class GameBoyAdvanceSoftwareRenderer{constructor(){this.LAYER_BG0=0,this.LAYER_BG1=1,this.LAYER_BG2=2,this.LAYER_BG3=3,this.LAYER_OBJ=4,this.LAYER_BACKDROP=5,this.HORIZONTAL_PIXELS=240,this.VERTICAL_PIXELS=160,this.LAYER_MASK=6,this.BACKGROUND_MASK=1,this.TARGET2_MASK=8,this.TARGET1_MASK=16,this.OBJWIN_MASK=32,this.WRITTEN_MASK=128,this.PRIORITY_MASK=this.LAYER_MASK|this.BACKGROUND_MASK,this.drawBackdrop=new function(a){this.bg=!0,this.priority=-1,this.index=a.LAYER_BACKDROP,this.enabled=!0,this.drawScanline=function(c,f,d,e){for(var b=d;b<e;++b)c.stencil[b]&a.WRITTEN_MASK?c.stencil[b]&a.TARGET1_MASK&&(c.color[b]=a.palette.mix(a.blendB,a.palette.accessColor(this.index,0),a.blendA,c.color[b]),c.stencil[b]=a.WRITTEN_MASK):(c.color[b]=a.palette.accessColor(this.index,0),c.stencil[b]=a.WRITTEN_MASK)}}(this)}clear(b){var a;this.palette=new GameBoyAdvancePalette,this.vram=new GameBoyAdvanceVRAM(b.SIZE_VRAM),this.oam=new GameBoyAdvanceOAM(b.SIZE_OAM),this.oam.video=this,this.objLayers=[new GameBoyAdvanceOBJLayer(this,0),new GameBoyAdvanceOBJLayer(this,1),new GameBoyAdvanceOBJLayer(this,2),new GameBoyAdvanceOBJLayer(this,3)],this.objwinLayer=new GameBoyAdvanceOBJLayer(this,4),this.objwinLayer.objwin=this.OBJWIN_MASK,this.backgroundMode=0,this.displayFrameSelect=0,this.hblankIntervalFree=0,this.objCharacterMapping=0,this.forcedBlank=1,this.win0=0,this.win1=0,this.objwin=0,this.vcount=-1,this.win0Left=0,this.win0Right=240,this.win1Left=0,this.win1Right=240,this.win0Top=0,this.win0Bottom=160,this.win1Top=0,this.win1Bottom=160,this.windows=new Array;for(a=0;a<4;++a)this.windows.push({enabled:[!1,!1,!1,!1,!1,!0],special:0});this.target1=new Array(5),this.target2=new Array(5),this.blendMode=0,this.blendA=0,this.blendB=0,this.blendY=0,this.bgMosaicX=1,this.bgMosaicY=1,this.objMosaicX=1,this.objMosaicY=1,this.lastHblank=0,this.nextHblank=this.HDRAW_LENGTH,this.nextEvent=this.nextHblank,this.nextHblankIRQ=0,this.nextVblankIRQ=0,this.nextVcounterIRQ=0,this.bg=new Array;for(a=0;a<4;++a)this.bg.push({bg:!0,index:a,enabled:!1,video:this,vram:this.vram,priority:0,charBase:0,mosaic:!1,multipalette:!1,screenBase:0,overflow:0,size:0,x:0,y:0,refx:0,refy:0,dx:1,dmx:0,dy:0,dmy:1,sx:0,sy:0,pushPixel:GameBoyAdvanceSoftwareRenderer.pushPixel,drawScanline:this.drawScanlineBGMode0});this.bgModes=[this.drawScanlineBGMode0,this.drawScanlineBGMode2,this.drawScanlineBGMode2,this.drawScanlineBGMode3,this.drawScanlineBGMode4,this.drawScanlineBGMode5],this.drawLayers=[this.bg[0],this.bg[1],this.bg[2],this.bg[3],this.objLayers[0],this.objLayers[1],this.objLayers[2],this.objLayers[3],this.objwinLayer,this.drawBackdrop],this.objwinActive=!1,this.alphaEnabled=!1,this.scanline={color:new Uint16Array(this.HORIZONTAL_PIXELS),stencil:new Uint8Array(this.HORIZONTAL_PIXELS)},this.sharedColor=[0,0,0],this.sharedMap={tile:0,hflip:!1,vflip:!1,palette:0}}clearSubsets(a,b){b&4&&this.palette.overwrite(new Uint16Array(a.SIZE_PALETTE>>1)),b&8&&this.vram.insert(0,new Uint16Array(a.SIZE_VRAM>>1)),b&16&&(this.oam.overwrite(new Uint16Array(a.SIZE_OAM>>1)),this.oam.video=this)}freeze(){}defrost(a){}setBacking(b){this.pixelData=b;for(var a=0;a<this.HORIZONTAL_PIXELS*this.VERTICAL_PIXELS*4;)this.pixelData.data[a++]=255,this.pixelData.data[a++]=255,this.pixelData.data[a++]=255,this.pixelData.data[a++]=255}writeDisplayControl(a){this.backgroundMode=a&7,this.displayFrameSelect=a&16,this.hblankIntervalFree=a&32,this.objCharacterMapping=a&64,this.forcedBlank=a&128,this.bg[0].enabled=a&256,this.bg[1].enabled=a&512,this.bg[2].enabled=a&1024,this.bg[3].enabled=a&2048,this.objLayers[0].enabled=a&4096,this.objLayers[1].enabled=a&4096,this.objLayers[2].enabled=a&4096,this.objLayers[3].enabled=a&4096,this.win0=a&8192,this.win1=a&16384,this.objwin=a&32768,this.objwinLayer.enabled=a&4096&&a&32768,this.bg[2].multipalette&=~1,this.bg[3].multipalette&=~1,this.backgroundMode>0&&(this.bg[2].multipalette|=1),this.backgroundMode==2&&(this.bg[3].multipalette|=1),this.resetLayers()}writeBackgroundControl(c,b){var a=this.bg[c];a.priority=b&3,a.charBase=(b&12)<<12,a.mosaic=b&64,a.multipalette&=~128,(c<2||this.backgroundMode==0)&&(a.multipalette|=b&128),a.screenBase=(b&7936)<<3,a.overflow=b&8192,a.size=(b&49152)>>14,this.drawLayers.sort(this.layerComparator)}writeBackgroundHOffset(a,b){this.bg[a].x=b&511}writeBackgroundVOffset(a,b){this.bg[a].y=b&511}writeBackgroundRefX(a,b){this.bg[a].refx=(b<<4)/4096,this.bg[a].sx=this.bg[a].refx}writeBackgroundRefY(a,b){this.bg[a].refy=(b<<4)/4096,this.bg[a].sy=this.bg[a].refy}writeBackgroundParamA(a,b){this.bg[a].dx=(b<<16)/16777216}writeBackgroundParamB(a,b){this.bg[a].dmx=(b<<16)/16777216}writeBackgroundParamC(a,b){this.bg[a].dy=(b<<16)/16777216}writeBackgroundParamD(a,b){this.bg[a].dmy=(b<<16)/16777216}writeWin0H(a){this.win0Left=(a&65280)>>8,this.win0Right=Math.min(this.HORIZONTAL_PIXELS,a&255),this.win0Left>this.win0Right&&(this.win0Right=this.HORIZONTAL_PIXELS)}writeWin1H(a){this.win1Left=(a&65280)>>8,this.win1Right=Math.min(this.HORIZONTAL_PIXELS,a&255),this.win1Left>this.win1Right&&(this.win1Right=this.HORIZONTAL_PIXELS)}writeWin0V(a){this.win0Top=(a&65280)>>8,this.win0Bottom=Math.min(this.VERTICAL_PIXELS,a&255),this.win0Top>this.win0Bottom&&(this.win0Bottom=this.VERTICAL_PIXELS)}writeWin1V(a){this.win1Top=(a&65280)>>8,this.win1Bottom=Math.min(this.VERTICAL_PIXELS,a&255),this.win1Top>this.win1Bottom&&(this.win1Bottom=this.VERTICAL_PIXELS)}writeWindow(c,a){var b=this.windows[c];b.enabled[0]=a&1,b.enabled[1]=a&2,b.enabled[2]=a&4,b.enabled[3]=a&8,b.enabled[4]=a&16,b.special=a&32}writeWinIn(a){this.writeWindow(0,a),this.writeWindow(1,a>>8)}writeWinOut(a){this.writeWindow(2,a),this.writeWindow(3,a>>8)}writeBlendControl(a){switch(this.target1[0]=!!(a&1)*this.TARGET1_MASK,this.target1[1]=!!(a&2)*this.TARGET1_MASK,this.target1[2]=!!(a&4)*this.TARGET1_MASK,this.target1[3]=!!(a&8)*this.TARGET1_MASK,this.target1[4]=!!(a&16)*this.TARGET1_MASK,this.target1[5]=!!(a&32)*this.TARGET1_MASK,this.target2[0]=!!(a&256)*this.TARGET2_MASK,this.target2[1]=!!(a&512)*this.TARGET2_MASK,this.target2[2]=!!(a&1024)*this.TARGET2_MASK,this.target2[3]=!!(a&2048)*this.TARGET2_MASK,this.target2[4]=!!(a&4096)*this.TARGET2_MASK,this.target2[5]=!!(a&8192)*this.TARGET2_MASK,this.blendMode=(a&192)>>6,this.blendMode){case 1:case 0:this.palette.makeNormalPalettes();break;case 2:this.palette.makeBrightPalettes(a&63);break;case 3:this.palette.makeDarkPalettes(a&63);break}}setBlendEnabled(a,b,c){if(this.alphaEnabled=b&&c==1,b)switch(c){case 1:case 0:this.palette.makeNormalPalette(a);break;case 2:case 3:this.palette.makeSpecialPalette(a);break}else this.palette.makeNormalPalette(a)}writeBlendAlpha(a){this.blendA=(a&31)/16,this.blendA>1&&(this.blendA=1),this.blendB=((a&7936)>>8)/16,this.blendB>1&&(this.blendB=1)}writeBlendY(a){this.blendY=a,this.palette.setBlendY(a>=16?1:a/16)}writeMosaic(a){this.bgMosaicX=(a&15)+1,this.bgMosaicY=(a>>4&15)+1,this.objMosaicX=(a>>8&15)+1,this.objMosaicY=(a>>12&15)+1}resetLayers(){this.backgroundMode>1&&(this.bg[0].enabled=!1,this.bg[1].enabled=!1),this.bg[2].enabled&&(this.bg[2].drawScanline=this.bgModes[this.backgroundMode]),this.backgroundMode==0||this.backgroundMode==2?this.bg[3].enabled&&(this.bg[3].drawScanline=this.bgModes[this.backgroundMode]):this.bg[3].enabled=!1,this.drawLayers.sort(this.layerComparator)}layerComparator(a,b){var c=b.priority-a.priority;return c?c:a.bg&&!b.bg?-1:!a.bg&&b.bg?1:b.index-a.index}accessMapMode0(g,e,c,f,b){var d=g+(c>>2&62)+f,a;e&1&&(d+=(c&256)<<3),a=this.vram.loadU16(d),b.tile=a&1023,b.hflip=a&1024,b.vflip=a&2048,b.palette=(a&61440)>>8}accessMapMode1(a,f,b,c,d){var e=a+(b>>3)+c;d.tile=this.vram.loadU8(e)}accessTile(b,c,d){var a=b+(c<<5);return a|=d<<2,this.vram.load32(a)}static pushPixel(c,o,a,k,m,f,e,b,l){var g,h,d,j,i,n;if(!l){if(this.multipalette?g=k>>(m<<3)&255:g=k>>(m<<2)&15,!g)return;this.multipalette||(g|=o.palette)}if(h=a.WRITTEN_MASK,d=e.stencil[f],j=a.blendMode,a.objwinActive)if(d&a.OBJWIN_MASK)if(a.windows[3].enabled[c])a.setBlendEnabled(c,a.windows[3].special&&a.target1[c],j),a.windows[3].special&&a.alphaEnabled&&(b|=a.target1[c]),h|=a.OBJWIN_MASK;else return;else if(a.windows[2].enabled[c])a.setBlendEnabled(c,a.windows[2].special&&a.target1[c],j),a.windows[2].special&&a.alphaEnabled&&(b|=a.target1[c]);else return;if(b&a.TARGET1_MASK&&d&a.TARGET2_MASK&&a.setBlendEnabled(c,!0,1),i=l?k:a.palette.accessColor(c,g),b&a.TARGET1_MASK&&a.setBlendEnabled(c,!!j,j),n=(b&a.PRIORITY_MASK)<(d&a.PRIORITY_MASK),(b&a.PRIORITY_MASK)==(d&a.PRIORITY_MASK)&&(n=b&a.BACKGROUND_MASK),d&a.WRITTEN_MASK)if(n)b&a.TARGET1_MASK&&d&a.TARGET2_MASK&&(i=a.palette.mix(a.blendA,i,a.blendB,e.color[f])),h|=b&~a.TARGET1_MASK;else if((b&a.PRIORITY_MASK)>(d&a.PRIORITY_MASK))if(h=d&~(a.TARGET1_MASK|a.TARGET2_MASK),b&a.TARGET2_MASK&&d&a.TARGET1_MASK)i=a.palette.mix(a.blendB,i,a.blendA,e.color[f]);else return;else return;else h|=b;if(b&a.OBJWIN_MASK){e.stencil[f]|=a.OBJWIN_MASK;return}e.color[f]=i,e.stencil[f]=h}identity(a){return a}drawScanlineBlank(b){for(var a=0;a<this.HORIZONTAL_PIXELS;++a)b.color[a]=65535,b.stencil[a]=0}prepareScanline(b){for(var a=0;a<this.HORIZONTAL_PIXELS;++a)b.stencil[a]=this.target2[this.LAYER_BACKDROP]}drawScanlineBGMode0(y,c,s,x){var a=this.video,v=a.vcount,k=s,t=c.x,w=c.y,j=v+w,g,d,h,f,l,p,q,e,r,b,o,u,i,n,m;this.mosaic&&(j-=v%a.bgMosaicY),f=j&7,p=c.screenBase,q=c.charBase,e=c.size,r=c.index,b=a.sharedMap,o=c.multipalette?1:0,u=a.target2[r]|c.priority<<1|a.BACKGROUND_MASK,a.blendMode==1&&a.alphaEnabled&&(u|=a.target1[r]),i=j<<3&1984,e==2?i+=j<<3&2048:e==3&&(i+=j<<4&4096),e&1?n=511:n=255,a.accessMapMode0(p,e,s+t&n,i,b),m=a.accessTile(q,b.tile<<o,(b.vflip?7-f:f)<<o);for(h=s;h<x;++h){if(g=h+t&n,l=this.mosaic?k%a.bgMosaicX:0,g-=l,d=g&7,o){if((!d||this.mosaic&&!l)&&a.accessMapMode0(p,e,g,i,b),!(d&3)||this.mosaic&&!l)if(m=a.accessTile(q+(!!(g&4)==!b.hflip?4:0),b.tile<<1,(b.vflip?7-f:f)<<1),!m&&!(d&3)){h+=3,k+=4;continue}}else if(!d||this.mosaic&&!l)if(a.accessMapMode0(p,e,g,i,b),m=a.accessTile(q,b.tile,b.vflip?7-f:f),!m&&!d){h+=7,k+=8;continue}b.hflip&&(d=7-d),c.pushPixel(r,b,a,m,d,k,y,u,!1),k++}}drawScanlineBGMode2(s,a,o,r){var b=this.video,m=b.vcount,i=o,q=a.screenBase,p=a.charBase,h=a.size,f=128<<h,j=a.index,g=b.sharedMap,n=b.target2[j]|a.priority<<1|b.BACKGROUND_MASK,c,d,l,e,k;b.blendMode==1&&b.alphaEnabled&&(n|=b.target1[j]);for(e=o;e<r;++e){if(c=a.dx*e+a.sx,d=a.dy*e+a.sy,this.mosaic&&(c-=e%b.bgMosaicX*a.dx+m%b.bgMosaicY*a.dmx,d-=e%b.bgMosaicX*a.dy+m%b.bgMosaicY*a.dmy),a.overflow)c&=f-1,c<0&&(c+=f),d&=f-1,d<0&&(d+=f);else if(c<0||d<0||c>=f||d>=f){i++;continue}k=(d<<1&2032)<<h,b.accessMapMode1(q,h,c,k,g),l=this.vram.loadU8(p+(g.tile<<6)+((d&7)<<3)+(c&7)),a.pushPixel(j,g,b,l,0,i,s,n,!1),i++}}drawScanlineBGMode3(l,b,j,n){var a=this.video,i=a.vcount,f=j,g=b.index,m=a.sharedMap,k=a.target2[g]|b.priority<<1|a.BACKGROUND_MASK,c,d,h,e,o;a.blendMode==1&&a.alphaEnabled&&(k|=a.target1[g]);for(c=j;c<n;++c){if(d=b.dx*c+b.sx,e=b.dy*c+b.sy,this.mosaic&&(d-=c%a.bgMosaicX*b.dx+i%a.bgMosaicY*b.dmx,e-=c%a.bgMosaicX*b.dy+i%a.bgMosaicY*b.dmy),d<0||e<0||d>=a.HORIZONTAL_PIXELS||e>=a.VERTICAL_PIXELS){f++;continue}h=this.vram.loadU16(e*a.HORIZONTAL_PIXELS+d<<1),b.pushPixel(g,m,a,h,0,f,l,k,!0),f++}}drawScanlineBGMode4(m,b,i,o){var a=this.video,h=a.vcount,g=i,k=0,e,d,c,q,f,n,j,l,p;a.displayFrameSelect&&(k+=40960),q=b.size,f=b.index,n=a.sharedMap,l=a.target2[f]|b.priority<<1|a.BACKGROUND_MASK,a.blendMode==1&&a.alphaEnabled&&(l|=a.target1[f]);for(c=i;c<o;++c){if(e=b.dx*c+b.sx,d=0|b.dy*c+b.sy,this.mosaic&&(e-=c%a.bgMosaicX*b.dx+h%a.bgMosaicY*b.dmx,d-=c%a.bgMosaicX*b.dy+h%a.bgMosaicY*b.dmy),p=d<<2&2016,e<0||d<0||e>=a.HORIZONTAL_PIXELS||d>=a.VERTICAL_PIXELS){g++;continue}j=this.vram.loadU8(k+d*a.HORIZONTAL_PIXELS+e),b.pushPixel(f,n,a,j,0,g,m,l,!1),g++}}drawScanlineBGMode5(m,b,j,o){var a=this.video,i=a.vcount,f=j,l=0,d,e,c,g,n,h,k,p;a.displayFrameSelect&&(l+=40960),g=b.index,n=a.sharedMap,k=a.target2[g]|b.priority<<1|a.BACKGROUND_MASK,a.blendMode==1&&a.alphaEnabled&&(k|=a.target1[g]);for(c=j;c<o;++c){if(d=b.dx*c+b.sx,e=b.dy*c+b.sy,this.mosaic&&(d-=c%a.bgMosaicX*b.dx+i%a.bgMosaicY*b.dmx,e-=c%a.bgMosaicX*b.dy+i%a.bgMosaicY*b.dmy),d<0||e<0||d>=160||e>=128){f++;continue}h=this.vram.loadU16(l+(e*160+d)<<1),b.pushPixel(g,n,a,h,0,f,m,k,!0),f++}}drawScanline(g){var b=this.scanline,a,c,f,d,e,h;if(this.forcedBlank){this.drawScanlineBlank(b);return}this.prepareScanline(b),this.vcount=g;for(h=0;h<this.drawLayers.length;++h){if(a=this.drawLayers[h],!a.enabled)continue;this.objwinActive=!1,this.win0||this.win1||this.objwin?(c=0,f=this.HORIZONTAL_PIXELS,d=0,e=this.HORIZONTAL_PIXELS,this.win0&&g>=this.win0Top&&g<this.win0Bottom&&(this.windows[0].enabled[a.index]&&(this.setBlendEnabled(a.index,this.windows[0].special&&this.target1[a.index],this.blendMode),a.drawScanline(b,a,this.win0Left,this.win0Right)),c=Math.max(c,this.win0Left),f=Math.min(f,this.win0Left),d=Math.max(d,this.win0Right),e=Math.min(e,this.win0Right)),this.win1&&g>=this.win1Top&&g<this.win1Bottom&&(this.windows[1].enabled[a.index]&&(this.setBlendEnabled(a.index,this.windows[1].special&&this.target1[a.index],this.blendMode),!this.windows[0].enabled[a.index]&&(this.win1Left<c||this.win1Right<d)?(a.drawScanline(b,a,this.win1Left,c),a.drawScanline(b,a,e,this.win1Right)):a.drawScanline(b,a,this.win1Left,this.win1Right)),c=Math.max(c,this.win1Left),f=Math.min(f,this.win1Left),d=Math.max(d,this.win1Right),e=Math.min(e,this.win1Right)),(this.windows[2].enabled[a.index]||this.objwin&&this.windows[3].enabled[a.index])&&(this.objwinActive=this.objwin,this.setBlendEnabled(a.index,this.windows[2].special&&this.target1[a.index],this.blendMode),f>d?a.drawScanline(b,a,0,this.HORIZONTAL_PIXELS):(f&&a.drawScanline(b,a,0,f),d<this.HORIZONTAL_PIXELS&&a.drawScanline(b,a,d,this.HORIZONTAL_PIXELS),e<c&&a.drawScanline(b,a,e,c))),this.setBlendEnabled(this.LAYER_BACKDROP,this.target1[this.LAYER_BACKDROP]&&this.windows[2].special,this.blendMode)):(this.setBlendEnabled(a.index,this.target1[a.index],this.blendMode),a.drawScanline(b,a,0,this.HORIZONTAL_PIXELS)),a.bg&&(a.sx+=a.dmx,a.sy+=a.dmy)}this.finishScanline(b)}finishScanline(d){for(var e=this.palette.accessColor(this.LAYER_BACKDROP,0),c=this.vcount*this.HORIZONTAL_PIXELS*4,f=this.target2[this.LAYER_BACKDROP],a=0,b;a<this.HORIZONTAL_PIXELS;++a)d.stencil[a]&this.WRITTEN_MASK?(b=d.color[a],f&&d.stencil[a]&this.TARGET1_MASK&&(b=this.palette.mix(this.blendA,b,this.blendB,e)),this.palette.convert16To32(b,this.sharedColor)):this.palette.convert16To32(e,this.sharedColor),this.pixelData.data[c++]=this.sharedColor[0],this.pixelData.data[c++]=this.sharedColor[1],this.pixelData.data[c++]=this.sharedColor[2],c++}startDraw(){}finishDraw(a){this.bg[2].sx=this.bg[2].refx,this.bg[2].sy=this.bg[2].refy,this.bg[3].sx=this.bg[3].refx,this.bg[3].sy=this.bg[3].refy,a.finishDraw(this.pixelData)}}