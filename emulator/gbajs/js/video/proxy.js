class MemoryProxy{constructor(d,b,a){if(this.owner=d,this.blocks=[],this.blockSize=a,this.mask=(1<<a)-1,this.size=b,a)for(var c=0;c<b>>a;++c)this.blocks.push(new MemoryView(new ArrayBuffer(1<<a)));else this.blockSize=31,this.mask=-1,this.blocks[0]=new MemoryView(new ArrayBuffer(b))}combine(){var b,a;if(this.blocks.length>1){b=new Uint8Array(this.size);for(a=0;a<this.blocks.length;++a)b.set(new Uint8Array(this.blocks[a].buffer),a<<this.blockSize);return b.buffer}return this.blocks[0].buffer}replace(b){for(var a=0;a<this.blocks.length;++a)this.blocks[a]=new MemoryView(b.slice(a<<this.blockSize,(a<<this.blockSize)+this.blocks[a].buffer.byteLength))}load8(a){return this.blocks[a>>this.blockSize].load8(a&this.mask)}load16(a){return this.blocks[a>>this.blockSize].load16(a&this.mask)}loadU8(a){return this.blocks[a>>this.blockSize].loadU8(a&this.mask)}loadU16(a){return this.blocks[a>>this.blockSize].loadU16(a&this.mask)}load32(a){return this.blocks[a>>this.blockSize].load32(a&this.mask)}store8(a,b){if(a>=this.size)return;this.owner.memoryDirtied(this,a>>this.blockSize),this.blocks[a>>this.blockSize].store8(a&this.mask,b),this.blocks[a>>this.blockSize].store8(a&this.mask^1,b)}store16(a,b){if(a>=this.size)return;return this.owner.memoryDirtied(this,a>>this.blockSize),this.blocks[a>>this.blockSize].store16(a&this.mask,b)}store32(a,b){if(a>=this.size)return;return this.owner.memoryDirtied(this,a>>this.blockSize),this.blocks[a>>this.blockSize].store32(a&this.mask,b)}invalidatePage(a){}}class GameBoyAdvanceRenderProxy{constructor(){var a,b;this.worker=new Worker('emulator/gbajs/js/video/worker.js'),this.currentFrame=0,this.delay=0,this.skipFrame=!1,this.dirty=null,a=this,b={finish:function(b){a.backing=b.backing,a.caller.finishDraw(a.backing),--a.delay}},this.worker.onmessage=function(a){b[a.data.type](a.data)}}memoryDirtied(a,b){this.dirty=this.dirty||{},this.dirty.memory=this.dirty.memory||{},a===this.palette&&(this.dirty.memory.palette=a.blocks[0].buffer),a===this.oam&&(this.dirty.memory.oam=a.blocks[0].buffer),a===this.vram&&(this.dirty.memory.vram=this.dirty.memory.vram||[],this.dirty.memory.vram[b]=a.blocks[b].buffer)}clear(a){this.palette=new MemoryProxy(this,a.SIZE_PALETTE_RAM,0),this.vram=new MemoryProxy(this,a.SIZE_VRAM,13),this.oam=new MemoryProxy(this,a.SIZE_OAM,0),this.dirty=null,this.scanlineQueue=[],this.worker.postMessage({type:'clear',SIZE_VRAM:a.SIZE_VRAM,SIZE_OAM:a.SIZE_OAM})}freeze(a){return{palette:Serializer.prefix(this.palette.combine()),vram:Serializer.prefix(this.vram.combine()),oam:Serializer.prefix(this.oam.combine())}}defrost(a,c){this.palette.replace(a.palette),this.memoryDirtied(this.palette,0),this.vram.replace(a.vram);for(var b=0;b<this.vram.blocks.length;++b)this.memoryDirtied(this.vram,b);this.oam.replace(a.oam),this.memoryDirtied(this.oam,0)}writeDisplayControl(a){this.dirty=this.dirty||{},this.dirty.DISPCNT=a}writeBackgroundControl(a,b){this.dirty=this.dirty||{},this.dirty.BGCNT=this.dirty.BGCNT||[],this.dirty.BGCNT[a]=b}writeBackgroundHOffset(a,b){this.dirty=this.dirty||{},this.dirty.BGHOFS=this.dirty.BGHOFS||[],this.dirty.BGHOFS[a]=b}writeBackgroundVOffset(a,b){this.dirty=this.dirty||{},this.dirty.BGVOFS=this.dirty.BGVOFS||[],this.dirty.BGVOFS[a]=b}writeBackgroundRefX(a,b){this.dirty=this.dirty||{},this.dirty.BGX=this.dirty.BGX||[],this.dirty.BGX[a]=b}writeBackgroundRefY(a,b){this.dirty=this.dirty||{},this.dirty.BGY=this.dirty.BGY||[],this.dirty.BGY[a]=b}writeBackgroundParamA(a,b){this.dirty=this.dirty||{},this.dirty.BGPA=this.dirty.BGPA||[],this.dirty.BGPA[a]=b}writeBackgroundParamB(a,b){this.dirty=this.dirty||{},this.dirty.BGPB=this.dirty.BGPB||[],this.dirty.BGPB[a]=b}writeBackgroundParamC(a,b){this.dirty=this.dirty||{},this.dirty.BGPC=this.dirty.BGPC||[],this.dirty.BGPC[a]=b}writeBackgroundParamD(a,b){this.dirty=this.dirty||{},this.dirty.BGPD=this.dirty.BGPD||[],this.dirty.BGPD[a]=b}writeWin0H(a){this.dirty=this.dirty||{},this.dirty.WIN0H=a}writeWin1H(a){this.dirty=this.dirty||{},this.dirty.WIN1H=a}writeWin0V(a){this.dirty=this.dirty||{},this.dirty.WIN0V=a}writeWin1V(a){this.dirty=this.dirty||{},this.dirty.WIN1V=a}writeWinIn(a){this.dirty=this.dirty||{},this.dirty.WININ=a}writeWinOut(a){this.dirty=this.dirty||{},this.dirty.WINOUT=a}writeBlendControl(a){this.dirty=this.dirty||{},this.dirty.BLDCNT=a}writeBlendAlpha(a){this.dirty=this.dirty||{},this.dirty.BLDALPHA=a}writeBlendY(a){this.dirty=this.dirty||{},this.dirty.BLDY=a}writeMosaic(a){this.dirty=this.dirty||{},this.dirty.MOSAIC=a}clearSubsets(a,b){if(this.dirty=this.dirty||{},b&4&&(this.palette=new MemoryProxy(this,a.SIZE_PALETTE_RAM,0),a.mmap(a.REGION_PALETTE_RAM,this.palette),this.memoryDirtied(this.palette,0)),b&8){this.vram=new MemoryProxy(this,a.SIZE_VRAM,13),a.mmap(a.REGION_VRAM,this.vram);for(var c=0;c<this.vram.blocks.length;++c)this.memoryDirtied(this.vram,c)}b&16&&(this.oam=new MemoryProxy(this,a.SIZE_OAM,0),a.mmap(a.REGION_OAM,this.oam),this.memoryDirtied(this.oam,0))}setBacking(a){this.backing=a,this.worker.postMessage({type:'start',backing:this.backing})}drawScanline(b){if(!this.skipFrame)if(this.dirty){if(this.dirty.memory)if(this.dirty.memory.palette&&(this.dirty.memory.palette=this.dirty.memory.palette.slice(0)),this.dirty.memory.oam&&(this.dirty.memory.oam=this.dirty.memory.oam.slice(0)),this.dirty.memory.vram)for(var a=0;a<12;++a)this.dirty.memory.vram[a]&&(this.dirty.memory.vram[a]=this.dirty.memory.vram[a].slice(0));this.scanlineQueue.push({y:b,dirty:this.dirty}),this.dirty=null}}startDraw(){++this.currentFrame,this.delay<=0&&(this.skipFrame=!1),this.skipFrame||++this.delay}finishDraw(a){this.caller=a,this.skipFrame||(this.worker.postMessage({type:'finish',scanlines:this.scanlineQueue,frame:this.currentFrame}),this.scanlineQueue=[],this.delay>2&&(this.skipFrame=!0))}}