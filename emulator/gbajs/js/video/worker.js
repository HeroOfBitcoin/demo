var video,proxyBacking,currentFrame,handlers;importScripts('software.js'),video=new GameBoyAdvanceSoftwareRenderer,proxyBacking=null,currentFrame=0,self.finishDraw=function(a){self.postMessage({type:'finish',backing:a,frame:currentFrame})};function receiveDirty(a){var b,c;for(b in a)switch(b){case'DISPCNT':video.writeDisplayControl(a[b]);break;case'BGCNT':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundControl(c,a[b][c]);break;case'BGHOFS':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundHOffset(c,a[b][c]);break;case'BGVOFS':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundVOffset(c,a[b][c]);break;case'BGX':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundRefX(c,a[b][c]);break;case'BGY':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundRefY(c,a[b][c]);break;case'BGPA':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundParamA(c,a[b][c]);break;case'BGPB':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundParamB(c,a[b][c]);break;case'BGPC':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundParamC(c,a[b][c]);break;case'BGPD':for(c in a[b])typeof a[b][c]=='number'&&video.writeBackgroundParamD(c,a[b][c]);break;case'WIN0H':video.writeWin0H(a[b]);break;case'WIN1H':video.writeWin1H(a[b]);break;case'WIN0V':video.writeWin0V(a[b]);break;case'WIN1V':video.writeWin1V(a[b]);break;case'WININ':video.writeWinIn(a[b]);break;case'WINOUT':video.writeWinOut(a[b]);break;case'BLDCNT':video.writeBlendControl(a[b]);break;case'BLDALPHA':video.writeBlendAlpha(a[b]);break;case'BLDY':video.writeBlendY(a[b]);break;case'MOSAIC':video.writeMosaic(a[b]);break;case'memory':receiveMemory(a.memory);break}}function receiveMemory(a){if(a.palette&&video.palette.overwrite(new Uint16Array(a.palette)),a.oam&&video.oam.overwrite(new Uint16Array(a.oam)),a.vram)for(var b=0;b<12;++b)a.vram[b]&&video.vram.insert(b<<12,new Uint16Array(a.vram[b]))}handlers={clear:function(a){video.clear(a)},scanline:function(a){receiveDirty(a.dirty),video.drawScanline(a.y,proxyBacking)},start:function(a){proxyBacking=a.backing,video.setBacking(a.backing)},finish:function(c){var d,b,a;currentFrame=c.frame,d=0;for(b=0;b<c.scanlines.length;++b){for(a=d;a<c.scanlines[b].y;++a)video.drawScanline(a,proxyBacking);d=c.scanlines[b].y+1,receiveDirty(c.scanlines[b].dirty),video.drawScanline(c.scanlines[b].y,proxyBacking)}for(a=d;a<160;++a)video.drawScanline(a,proxyBacking);video.finishDraw(self)}},self.onmessage=function(a){handlers[a.data.type](a.data)}