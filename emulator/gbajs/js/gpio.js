class GameBoyAdvanceGPIO{constructor(a,b){this.core=a,this.rom=b,this.readWrite=0,this.direction=0,this.device=new GameBoyAdvanceRTC(this)}store16(a,b){switch(a){case 196:this.device.setPins(b&15);break;case 198:this.direction=b&15,this.device.setDirection(this.direction);break;case 200:this.readWrite=b&1;break;default:throw new Error('BUG: Bad offset passed to GPIO: '+a.toString(16))}if(this.readWrite){var c=this.rom.view.getUint16(a,!0);c&=~this.direction,this.rom.view.setUint16(a,c|b&this.direction,!0)}}outputPins(b){if(this.readWrite){var a=this.rom.view.getUint16(196,!0);a&=this.direction,this.rom.view.setUint16(196,a|b&~this.direction&15,!0)}}}class GameBoyAdvanceRTC{constructor(a){this.gpio=a,this.pins=0,this.direction=0,this.totalBytes=[0,0,7,0,1,0,3,0],this.bytesRemaining=0,this.transferStep=0,this.reading=0,this.bitsRead=0,this.bits=0,this.command=-1,this.control=64,this.time=[0,0,0,0,0,0,0]}setPins(a){switch(this.transferStep){case 0:(a&5)==1&&(this.transferStep=1);break;case 1:a&4&&(this.transferStep=2);break;case 2:a&1?a&4?this.direction&2&&!this.read?(++this.bitsRead,this.bitsRead==8&&this.processByte()):(this.gpio.outputPins(5|this.sioOutputPin()<<1),++this.bitsRead,this.bitsRead==8&&(--this.bytesRemaining,this.bytesRemaining<=0&&(this.command=-1),this.bitsRead=0)):(this.bitsRead=0,this.bytesRemaining=0,this.command=-1,this.transferStep=0):(this.bits&=~(1<<this.bitsRead),this.bits|=(a&2)>>1<<this.bitsRead);break}this.pins=a&7}setDirection(a){this.direction=a}processByte(){switch(--this.bytesRemaining,this.command){case-1:if((this.bits&15)==6)switch(this.command=this.bits>>4&7,this.reading=this.bits&128,this.bytesRemaining=this.totalBytes[this.command],this.command){case 0:this.control=0;break;case 2:case 6:this.updateClock();break}else this.gpio.core.WARN('Invalid RTC command byte: '+this.bits.toString(16));break;case 4:this.control=this.bits&64;break}this.bits=0,this.bitsRead=0,this.bytesRemaining||(this.command=-1)}sioOutputPin(){var a=0,b;switch(this.command){case 4:a=this.control;break;case 2:case 6:a=this.time[7-this.bytesRemaining];break}return b=a>>this.bitsRead&1,b}updateClock(){var a=new Date;this.time[0]=this.bcd(a.getFullYear()),this.time[1]=this.bcd(a.getMonth()+1),this.time[2]=this.bcd(a.getDate()),this.time[3]=a.getDay()-1,this.time[3]<0&&(this.time[3]=6),this.control&64?this.time[4]=this.bcd(a.getHours()):(this.time[4]=this.bcd(a.getHours()%2),a.getHours()>=12&&(this.time[4]|=128)),this.time[5]=this.bcd(a.getMinutes()),this.time[6]=this.bcd(a.getSeconds())}bcd(a){var b=a%10;return a/=10,b+=a%10<<4,b}}