class GameBoyAdvance{constructor(){this.LOG_ERROR=1,this.LOG_WARN=2,this.LOG_STUB=4,this.LOG_INFO=8,this.LOG_DEBUG=16,this.SYS_ID='com.endrift.gbajs',this.logLevel=this.LOG_ERROR|this.LOG_WARN,this.rom=null,this.cpu=new ARMCore,this.mmu=new GameBoyAdvanceMMU,this.irq=new GameBoyAdvanceInterruptHandler,this.io=new GameBoyAdvanceIO,this.audio=new GameBoyAdvanceAudio,this.video=new GameBoyAdvanceVideo,this.keypad=new GameBoyAdvanceKeypad,this.sio=new GameBoyAdvanceSIO,this.cpu.mmu=this.mmu,this.cpu.irq=this.irq,this.mmu.cpu=this.cpu,this.mmu.core=this,this.irq.cpu=this.cpu,this.irq.io=this.io,this.irq.audio=this.audio,this.irq.video=this.video,this.irq.core=this,this.io.cpu=this.cpu,this.io.audio=this.audio,this.io.video=this.video,this.io.keypad=this.keypad,this.io.sio=this.sio,this.io.core=this,this.audio.cpu=this.cpu,this.audio.core=this,this.video.cpu=this.cpu,this.video.core=this,this.keypad.core=this,this.sio.core=this,this.keypad.registerHandlers(),this.doStep=this.waitFrame,this.paused=!1,this.seenFrame=!1,this.seenSave=!1,this.lastVblank=0,this.queue=null,this.reportFPS=null,this.throttle=16;var a=this;window.queueFrame=function(b){a.queue=window.setTimeout(b,a.throttle)},window.URL=window.URL||window.webkitURL,this.video.vblankCallback=function(){a.seenFrame=!0}}setCanvas(a){var b,c;a.offsetWidth!=240||a.offsetHeight!=160?(b=this,this.indirectCanvas=document.createElement('canvas'),this.indirectCanvas.setAttribute('height','160'),this.indirectCanvas.setAttribute('width','240'),this.targetCanvas=a,this.setCanvasDirect(this.indirectCanvas),c=a.getContext('2d'),this.video.drawCallback=function(){c.drawImage(b.indirectCanvas,0,0,a.width,a.height)}):(this.setCanvasDirect(a),b=this)}setCanvasDirect(a){this.context=a.getContext('2d'),this.video.setBacking(this.context)}setBios(a,b){this.mmu.loadBios(a,b)}setRom(a){return!(this.reset(),this.rom=this.mmu.loadRom(a,!0),!this.rom)&&(this.retrieveSavedata(),!0)}hasRom(){return!!this.rom}loadRomFromFile(c,a){var b=new FileReader,d=this;b.onload=function(b){var c=d.setRom(b.target.result);a&&a(c)},b.readAsArrayBuffer(c)}reset(){this.audio.pause(!0),this.mmu.clear(),this.io.clear(),this.audio.clear(),this.video.clear(),this.sio.clear(),this.mmu.mmap(this.mmu.REGION_IO,this.io),this.mmu.mmap(this.mmu.REGION_PALETTE_RAM,this.video.renderPath.palette),this.mmu.mmap(this.mmu.REGION_VRAM,this.video.renderPath.vram),this.mmu.mmap(this.mmu.REGION_OAM,this.video.renderPath.oam),this.cpu.resetCPU(0)}step(){while(this.doStep())this.cpu.step()}waitFrame(){var a=this.seenFrame;return this.seenFrame=!1,!a}pause(){this.paused=!0,this.audio.pause(!0),this.queue&&(clearTimeout(this.queue),this.queue=null)}advanceFrame(){this.step(),this.seenSave?this.mmu.saveNeedsFlush()?this.mmu.flushSave():(this.storeSavedata(),this.seenSave=!1):this.mmu.saveNeedsFlush()&&(this.seenSave=!0,this.mmu.flushSave())}runStable(){var a,d,c,b,e;if(this.interval)return;a=this,d=0,c=0,e=Date.now(),this.paused=!1,this.audio.pause(!1),this.reportFPS?b=function(){try{if(d+=Date.now()-e,a.paused)return;queueFrame(b),e=Date.now(),a.advanceFrame(),++c,c==60&&(a.reportFPS(c*1e3/d),c=0,d=0)}catch(b){throw a.ERROR(b),b.stack&&a.logStackTrace(b.stack.split('\n')),b}}:b=function(){try{if(a.paused)return;queueFrame(b),a.advanceFrame()}catch(b){throw a.ERROR(b),b.stack&&a.logStackTrace(b.stack.split('\n')),b}},queueFrame(b)}setSavedata(a){this.mmu.loadSavedata(a)}loadSavedataFromFile(b){var a=new FileReader,c=this;a.onload=function(a){c.setSavedata(a.target.result)},a.readAsArrayBuffer(b)}decodeSavedata(a){this.setSavedata(this.decodeBase64(a))}decodeBase64(c){var d=c.length*3/4,f,e,g,a,b;c[c.length-2]=='='?d-=2:c[c.length-1]=='='&&(d-=1),f=new ArrayBuffer(d),e=new Uint8Array(f),g=c.match(/..../g);for(a=0;a+2<d;a+=3)b=atob(g.shift()),e[a]=b.charCodeAt(0),e[a+1]=b.charCodeAt(1),e[a+2]=b.charCodeAt(2);return a<d&&(b=atob(g.shift()),e[a++]=b.charCodeAt(0),b.length>1&&(e[a++]=b.charCodeAt(1))),f}encodeBase64(d){for(var b=[],a=[],c=0,f,e;c<d.byteLength;++c)for(e=d.getUint8(c,!0),a.push(String.fromCharCode(e));a.length>=3;)f=a.splice(0,3),b.push(btoa(f.join('')));return a.length&&b.push(btoa(a.join(''))),b.join('')}downloadSavedata(d){var b=this.mmu.save,a,c,e;if(!b)return this.WARN('No save data available'),null;window.URL?(a=$("<a style='display: none;'/>"),c=window.URL.createObjectURL(new Blob([b.buffer],{type:'data:application/x-spss-sav'})),a.attr('href',c),a.attr('download',d),$('body').append(a),a[0].click(),window.URL.revokeObjectURL(c),a.remove()):(e=this.encodeBase64(b.view),window.open('data:application/octet-stream;base64,'+e,this.rom.code+'.sav'))}storeSavedata(){var a=this.mmu.save,b;try{b=window.localStorage,b[this.SYS_ID+'.'+this.mmu.cart.code]=this.encodeBase64(a.view)}catch(a){this.WARN('Could not store savedata! '+a)}}retrieveSavedata(){var b,a;try{if(b=window.localStorage,a=b[this.SYS_ID+'.'+this.mmu.cart.code],a)return this.decodeSavedata(a),!0}catch(a){this.WARN('Could not retrieve savedata! '+a)}return!1}freeze(){return{cpu:this.cpu.freeze(),mmu:this.mmu.freeze(),irq:this.irq.freeze(),io:this.io.freeze(),audio:this.audio.freeze(),video:this.video.freeze()}}defrost(a){this.cpu.defrost(a.cpu),this.mmu.defrost(a.mmu),this.audio.defrost(a.audio),this.video.defrost(a.video),this.irq.defrost(a.irq),this.io.defrost(a.io)}log(a,b){}setLogger(a){this.log=a}logStackTrace(a){var c=a.length-32,b;this.ERROR('Stack trace follows:'),c>0&&this.log(-1,'> (Too many frames)');for(b=Math.max(c,0);b<a.length;++b)this.log(-1,'> '+a[b])}ERROR(a){this.logLevel&this.LOG_ERROR&&this.log(this.LOG_ERROR,a)}WARN(a){this.logLevel&this.LOG_WARN&&this.log(this.LOG_WARN,a)}STUB(a){this.logLevel&this.LOG_STUB&&this.log(this.LOG_STUB,a)}INFO(a){this.logLevel&this.LOG_INFO&&this.log(this.LOG_INFO,a)}DEBUG(a){this.logLevel&this.LOG_DEBUG&&this.log(this.LOG_DEBUG,a)}ASSERT_UNREACHED(a){throw new Error('Should be unreached: '+a)}ASSERT(a,b){if(!a)throw new Error('Assertion failed: '+b)}}