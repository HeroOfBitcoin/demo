function Console(a){this.cpu=a.cpu,this.gba=a,this.ul=document.getElementById('console'),this.gprs=document.getElementById('gprs'),this.memory=new Memory(a.mmu),this.breakpoints=[],this.logQueue=[],this.activeView=null,this.paletteView=new PaletteViewer(a.video.renderPath.palette),this.tileView=new TileViewer(a.video.renderPath.vram,a.video.renderPath.palette),this.update();var b=this;a.setLogger(function(a,c){b.log(a,c)}),this.gba.doStep=function(){return b.testBreakpoints()}}Console.prototype.updateGPRs=function(){for(var a=0;a<16;++a)this.gprs.children[a].textContent=hex(this.cpu.gprs[a])},Console.prototype.updateCPSR=function(){var a=this.cpu,c=function(c,d){var b=document.getElementById(c);a[d]?b.removeAttribute('class'):b.setAttribute('class','disabled')},b;switch(c('cpsrN','cpsrN'),c('cpsrZ','cpsrZ'),c('cpsrC','cpsrC'),c('cpsrV','cpsrV'),c('cpsrI','cpsrI'),c('cpsrT','execMode'),b=document.getElementById('mode'),a.mode){case a.MODE_USER:b.textContent='USER';break;case a.MODE_IRQ:b.textContent='IRQ';break;case a.MODE_FIQ:b.textContent='FIQ';break;case a.MODE_SUPERVISOR:b.textContent='SVC';break;case a.MODE_ABORT:b.textContent='ABORT';break;case a.MODE_UNDEFINED:b.textContent='UNDEFINED';break;case a.MODE_SYSTEM:b.textContent='SYSTEM';break;default:b.textContent='???';break}},Console.prototype.log=function(b,a){switch(b){case this.gba.LOG_ERROR:a='[ERROR] '+a;break;case this.gba.LOG_WARN:a='[WARN] '+a;break;case this.gba.LOG_STUB:a='[STUB] '+a;break;case this.gba.LOG_INFO:a='[INFO] '+a;break;case this.gba.LOG_DEBUG:a='[DEBUG] '+a;break}this.logQueue.push(a),b==this.gba.LOG_ERROR&&this.pause(),this.stillRunning||this.flushLog()},Console.prototype.flushLog=function(){for(var e=this.ul.scrollTop==this.ul.scrollHeight-this.ul.offsetHeight,c,a,b,d;this.logQueue.length;)c=document.createElement('li'),c.textContent=this.logQueue.shift(),this.ul.appendChild(c);e&&(a=this.ul,b=a.scrollTop,d=function(){a.scrollTop==b&&(a.scrollTop=(a.scrollHeight-a.offsetHeight)*.2+b*.8,b=a.scrollTop,b!=a.scrollHeight-a.offsetHeight&&setTimeout(d,25))},setTimeout(d,25))},Console.prototype.update=function(){this.updateGPRs(),this.updateCPSR(),this.memory.refreshAll(),this.activeView&&this.activeView.redraw()},Console.prototype.setView=function(a){for(var b=document.getElementById('debugViewer');b.hasChildNodes();)b.removeChild(b.lastChild);a&&(a.insertChildren(b),a.redraw()),this.activeView=a},Console.prototype.step=function(){try{this.cpu.step(),this.update()}catch(a){throw this.log(this.gba.LOG_DEBUG,a),a}},Console.prototype.runVisible=function(){if(this.stillRunning)return;this.stillRunning=!0;var a=this;run=function(){if(a.stillRunning)try{if(a.step(),a.breakpoints.length&&a.breakpoints[a.cpu.gprs[a.cpu.PC]]){a.breakpointHit();return}a.flushLog(),setTimeout(run,0)}catch(b){throw a.log(this.gba.LOG_DEBUG,b),a.pause(),b}},setTimeout(run,0)},Console.prototype.run=function(){var a,b,c,d;if(this.stillRunning)return;this.stillRunning=!0,a=document.getElementById('registers'),b=document.getElementById('memory'),c=Date.now(),a.setAttribute('class','disabled'),b.setAttribute('class','disabled'),d=this,this.gba.runStable()},Console.prototype.runFrame=function(){var b,c,d,a;if(this.stillRunning)return;this.stillRunning=!0,b=document.getElementById('registers'),c=document.getElementById('memory'),d=Date.now(),b.setAttribute('class','disabled'),c.setAttribute('class','disabled'),a=this,run=function(){a.gba.step(),a.pause()},setTimeout(run,0)},Console.prototype.pause=function(){var a,b;this.stillRunning=!1,this.gba.pause(),a=document.getElementById('registers'),b=document.getElementById('memory'),b.removeAttribute('class'),a.removeAttribute('class'),this.update(),this.flushLog()},Console.prototype.breakpointHit=function(){this.pause(),this.log(this.gba.LOG_DEBUG,'Hit breakpoint at '+hex(this.cpu.gprs[this.cpu.PC]))},Console.prototype.addBreakpoint=function(c){var a,b,d;this.breakpoints[c]=!0,a=document.getElementById('bp'+c),a||(a=document.createElement('li'),a.address=c,b=document.createElement('input'),b.setAttribute('type','checkbox'),b.setAttribute('checked','checked'),d=this,b.addEventListener('click',function(){d.breakpoints[c]=b.checked},!1),a.appendChild(b),a.appendChild(document.createTextNode(hex(c))),document.getElementById('breakpointView').appendChild(a))},Console.prototype.testBreakpoints=function(){return this.breakpoints.length&&this.breakpoints[this.cpu.gprs[this.cpu.PC]]?(this.breakpointHit(),!1):this.gba.waitFrame()},Memory=function(c){var a,b;this.mmu=c,this.ul=document.getElementById('memoryView'),row=this.createRow(0),this.ul.appendChild(row),this.rowHeight=row.offsetHeight,this.numberRows=this.ul.parentNode.offsetHeight/this.rowHeight+2,this.ul.removeChild(row),this.scrollTop=50-this.ul.parentElement.firstElementChild.offsetHeight;for(a=0;a<this.numberRows;++a)this.ul.appendChild(this.createRow(a<<4));this.ul.parentElement.scrollTop=this.scrollTop,b=this,this.ul.parentElement.addEventListener('scroll',function(a){b.scroll(a)},!0),window.addEventListener('resize',function(a){b.resize()},!0)},Memory.prototype.scroll=function(b){for(var a;this.ul.parentElement.scrollTop-this.scrollTop<this.rowHeight;){if(this.ul.firstChild.offset==0)break;a=this.ul.lastChild,this.ul.removeChild(a),a.offset=this.ul.firstChild.offset-16,this.refresh(a),this.ul.insertBefore(a,this.ul.firstChild),this.ul.parentElement.scrollTop+=this.rowHeight}while(this.ul.parentElement.scrollTop-this.scrollTop>this.rowHeight*2)a=this.ul.firstChild,this.ul.removeChild(a),a.offset=this.ul.lastChild.offset+16,this.refresh(a),this.ul.appendChild(a),this.ul.parentElement.scrollTop-=this.rowHeight;this.ul.parentElement.scrollTop<this.scrollTop&&(this.ul.parentElement.scrollTop=this.scrollTop,b.preventDefault())},Memory.prototype.resize=function(){var b,a,c;if(this.numberRows=this.ul.parentNode.offsetHeight/this.rowHeight+2,this.numberRows>this.ul.children.length){b=this.ul.lastChild.offset+16;for(a=0;a<this.numberRows-this.ul.children.length;++a)c=this.createRow(b),this.refresh(c),this.ul.appendChild(c),b+=16}else for(a=0;a<this.ul.children.length-this.numberRows;++a)this.ul.removeChild(this.ul.lastChild)},Memory.prototype.refresh=function(b){var e,c,a,d;b.firstChild.textContent=hex(b.offset),b.oldOffset==b.offset?e=!0:(b.oldOffset=b.offset,e=!1);for(d=0;d<16;++d){a=b.children[d+1];try{c=this.mmu.loadU8(b.offset+d),c>=0?(c=hex(c,2,!1),a.textContent==c?a.setAttribute('class','memoryCell'):e?(a.setAttribute('class','memoryCell changed'),a.textContent=c):(a.setAttribute('class','memoryCell'),a.textContent=c)):(a.setAttribute('class','memoryCell'),a.textContent='--')}catch(b){a.setAttribute('class','memoryCell'),a.textContent='--'}}},Memory.prototype.refreshAll=function(){for(var a=0;a<this.ul.children.length;++a)this.refresh(this.ul.children[a])},Memory.prototype.createRow=function(b){var a=document.createElement('li'),c=document.createElement('span'),e,d;c.setAttribute('class','memoryOffset'),c.textContent=hex(b),a.appendChild(c);for(e=0;e<16;++e)d=document.createElement('span'),d.textContent='00',d.setAttribute('class','memoryCell'),a.appendChild(d);return a.offset=b,a.oldOffset=b,a},Memory.prototype.scrollTo=function(c){var a,b;if(c&=4294967280,c){for(a=0;a<this.ul.children.length;++a)b=this.ul.children[a],b.offset=c+(a-1)*16,this.refresh(b);this.ul.parentElement.scrollTop=this.scrollTop+this.rowHeight}else{for(a=0;a<this.ul.children.length;++a)b=this.ul.children[a],b.offset=c+a*16,this.refresh(b);this.ul.parentElement.scrollTop=this.scrollTop}};function PaletteViewer(a){this.palette=a,this.view=document.createElement('canvas'),this.view.setAttribute('class','paletteView'),this.view.setAttribute('width','240'),this.view.setAttribute('height','500')}PaletteViewer.prototype.insertChildren=function(a){a.appendChild(this.view)},PaletteViewer.prototype.redraw=function(){var d=this.view.getContext('2d'),a,b,c,e,f,g,h;d.clearRect(0,0,this.view.width,this.view.height);for(a=0;a<2;++a)for(b=0;b<16;++b)for(c=0;c<16;++c)e=this.palette.loadU16((a*256+b*16+c)*2),f=(e&31)<<3,g=(e&992)>>2,h=(e&31744)>>7,d.fillStyle='#'+hex(f,2,!1)+hex(g,2,!1)+hex(h,2,!1),d.fillRect(c*15+1,b*15+a*255+1,13,13)};function TileViewer(a,b){this.BG_MAP_WIDTH=256,this.vram=a,this.palette=b,this.view=document.createElement('canvas'),this.view.setAttribute('class','tileView'),this.view.setAttribute('width','256'),this.view.setAttribute('height','512'),this.activePalette=0}TileViewer.prototype.insertChildren=function(a){a.appendChild(this.view)},TileViewer.prototype.redraw=function(){for(var c=this.view.getContext('2d'),d=c.createImageData(this.BG_MAP_WIDTH,512),e=0,a=0,b;a<512;a+=8)for(b=0;b<this.BG_MAP_WIDTH;b+=8)this.drawTile(d.data,e,this.activePalette,b+a*this.BG_MAP_WIDTH,this.BG_MAP_WIDTH),++e;c.putImageData(d,0,0)},TileViewer.prototype.drawTile=function(c,k,i,d,e){for(var b=0,g,h,a,j,f,l,m,n;b<8;++b){g=k<<5,g|=b<<2,h=this.vram.load32(g);for(a=0;a<8;++a)j=h>>(a<<2)&15,f=this.palette.loadU16((j<<1)+(i<<5)),l=(f&31)<<3,m=(f&992)>>2,n=(f&31744)>>7,c[(d+a+e*b)*4+0]=l,c[(d+a+e*b)*4+1]=m,c[(d+a+e*b)*4+2]=n,c[(d+a+e*b)*4+3]=255}}