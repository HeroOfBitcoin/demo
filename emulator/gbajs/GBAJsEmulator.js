class GBAJsEmulator{constructor(a){this.canvasId=a,this.gba=null,this.runCommands=[],this.debug=null,this.isRunning=!1;try{if(this.gba=new GameBoyAdvance,this.gba.keypad.eatInput=!0,this.gba.setLogger(function(e,d){console.log(d),this.gba.pause();let b=document.getElementById(a);if(b.getAttribute('class')==='dead'){console.log('We appear to have crashed multiple times without reseting.');return}let c=document.createElement('img');c.setAttribute('id','crash'),c.setAttribute('src','resources/crash.png'),b.parentElement.insertBefore(c,b),b.setAttribute('class','dead')}),this.gba&&FileReader){let b=document.getElementById(a);this.gba.setCanvas(b),this.gba.logLevel=this.gba.LOG_ERROR,this.gba.setBios(biosBin)}else throw new Error('GBA/FileReader do not exist, exiting')}catch(a){this.gba=null,this.invalid=!0,this.errors=['exception loading gba:'+a],console.log('exception loading gba:'+a)}}run(b,c){var a=this;this.gba.loadRomFromFile(b,function(b){if(b){for(let b=0;b<a.runCommands.length;++b)a.runCommands[b]();a.runCommands=[],a.gba.runStable(),a.isRunning=!0}c(b)})}loadSave(a){var b=this;this.runCommands.push(function(){b.gba.loadSavedataFromFile(a),$('#saveloader').val('')})}pause(){this.debug&&this.debug.gbaCon?this.debug.gbaCon.pause():this.gba.pause()}resume(){this.debug&&this.debug.gbaCon?this.debug.gbaCon.run():this.gba.runStable()}getPaused(){return this.gba.paused}getIsRunning(){return this.isRunning}setVolume(a){this.gba.audio.masterVolume=a}getVolume(){return this.gba.audio.masterVolume}setPixelated(b){let c=document.getElementById(this.canvasId),a=c.getContext('2d');a&&(a.imageSmoothingEnabled=!b)}reset(){let b=!1;this.gba.pause(),this.gba.reset(),this.isRunning=!1;let a=document.getElementById('crash');if(a){let c=this.gba.targetCanvas.getContext('2d');c.clearRect(0,0,480,320),this.gba.video.drawCallback(),a.parentElement.removeChild(a);let d=document.getElementById(this.canvasId);d.removeAttribute('class'),b=!0}return b}quickReload(){return!1}downloadSave(a){this.gba.downloadSavedata(a)}getCurrentSave(){var a=this.gba.mmu.save;return!!a&&a.buffer}enableKeyboardInput(){this.gba.keypad.keymodalactive=!1}disableKeyboardInput(){this.gba.keypad.keymodalactive=!0}simulateKeyDown(b){var a=this.gba.keypad.getKeyCodeValue(b.toUpperCase());this.gba.keypad.keyboardHandler(new KeyboardEvent('keydown',{keyCode:a,which:a,shiftKey:!1,ctrlKey:!1,metaKey:!1}))}simulateKeyUp(b){var a=this.gba.keypad.getKeyCodeValue(b.toUpperCase());this.gba.keypad.keyboardHandler(new KeyboardEvent('keyup',{keyCode:a,which:a,shiftKey:!1,ctrlKey:!1,metaKey:!1}))}remapKeyBinding(b,c,d){var a=parseFloat(c);Number.isNaN(a)||this.gba.keypad.remapKeycode(b.toUpperCase(),a)}setFastForward(b=null,a){this.gba.paused?this.gba.throttle=a:(this.gba.pause(),clearTimeout(this.gba.queue),this.gba.throttle=a,this.gba.runStable())}screenShot(){var a=document.createElement('canvas'),b=a.getContext('2d'),d;b.mozImageSmoothingEnabled=!1,b.webkitImageSmoothingEnabled=!1,b.msImageSmoothingEnabled=!1,b.imageSmoothingEnabled=!1,a.height=$('#screenwrapper').height(),a.width=$('#screenwrapper').width(),d=document.getElementById('screen'),b.drawImage(d,0,0,a.width,a.height);let e=a.toDataURL(),c=new Image;c.src=e;let f=window.open('');f.document.write(c.outerHTML)}defaultKeyBindings(){return[{descrip:'Up',keybind:'Up'},{descrip:'Down',keybind:'Down'},{descrip:'Left',keybind:'Left'},{descrip:'Right',keybind:'Right'},{descrip:'A',keybind:'Z'},{descrip:'B',keybind:'X'},{descrip:'L',keybind:'A'},{descrip:'R',keybind:'S'},{descrip:'Start',keybind:'Enter'},{descrip:'Select',keybind:'\\'}]}quitGame(){this.reset(),this.lcdFade(),this.isPaused=!1,this.isRunning=!1}quitEmulator(){this.reset(),this.lcdFade(),this.isPaused=!1,this.isRunning=!1}audioPolyfill(a=null){if(typeof this.gba=='undefined'||typeof this.gba.audio=='undefined'||typeof this.gba.audio.context=='undefined')return;this.gba.audio.context.state=='suspended'&&this.gba.audio.context.resume(),this.gba.audio.context.state=='running'&&a&&a()}lcdFade(){let b=this.gba.context,c=this.gba.targetCanvas.getContext('2d'),d=this.gba.video.drawCallback,a=0,e=setInterval(function(){a++;let f=b.getImageData(0,0,240,160);for(let b=0;b<160;++b)for(let c=0;c<240;++c){let d=Math.abs(c-120),e=Math.abs(b-80)*.8,g=(120-a-d)/120,h=(80-a-(b&1)*10-e+Math.pow(d,1/2))/80;f.data[(c+b*240)*4+3]*=Math.pow(g,1/3)*Math.pow(h,1/2)}b.putImageData(f,0,0),c.clearRect(0,0,480,320),a>40?clearInterval(e):d()},50)}enableDebug(){window.gba=this.gba;const b=location.protocol+'//'+location.host;var a=this;window.onmessage=function(c){if(c.origin!=b&&(c.origin!='file://'||b)){console.log('Failed XSS');return}switch(c.data){case'connect':c.source===a.debug&&a.debug.postMessage('connect',b||'*');break;case'connected':break;case'disconnect':c.source===a.debug&&(a.debug=null)}},window.onunload=function(){a.debug&&a.debug.postMessage&&a.debug.postMessage('disconnect',b||'*')},!this.debug||!this.debug.postMessage?this.debug=window.open('debugger.html','debug'):this.debug.postMessage('connect',b||'*')}isDebugActive(){return!!this.debug}}