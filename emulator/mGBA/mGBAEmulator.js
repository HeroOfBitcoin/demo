class mGBAEmulator{constructor(a){this.isPaused=!1,this.isRunning=!1,this.savePath='/data/saves/',this.romPath='/data/games/',this.cheatsPath='/data/cheats/',this.saveStatePath='/data/states',this.module={canvas:function(){return document.getElementById(a)}()};var b=this;mGBA(this.module).then(function(a){b.version=a.version.projectName+' '+a.version.projectVersion,a.FSInit()})}run(b,c=null){var d=new FileReader,a=this;d.onload=function(d){a.isRunning=a.loadBuffer(b.name,d.target.result),c&&c(a.isRunning)},d.readAsArrayBuffer(b)}loadSave(a){var b=new FileReader,c=this;b.onload=function(b){c.writeSav(a.name,b.target.result)},b.readAsArrayBuffer(a)}loadCheatsFile(b){var c=new FileReader,a=this;c.onload=function(c){a.writeCheats(b.name,c.target.result),a.isRunning&&a.module.autoLoadCheats()},c.readAsArrayBuffer(b)}parseCheatsString(a){return this.parseCheatsStringLibRetro(a)}parseCheatsStringLibRetro(c){const b=c.split('\n');if(!b[0].match('^cheats = [0-9]+'))return!1;let a={};for(const d of b){if(d.startsWith('cheats = ')||d==='')continue;const c=d.match(/^cheat([0-9]+)_([a-zA-Z]+)\s*=\s*"?([a-zA-Z0-9\s\+:_]+)"?$/);if(c){const b=c[1],d=c[2],e=c[3];a[b]?a[b][d]=e:(a[b]={},a[b][d]=e)}}return a}getCurrentCheatsFile(){let a=this.filepathToFileName(this.module.gameName,'.cheats');try{return this.module.FS.readFile(this.cheatsPath+a)}catch{return null}}getCurrentCheatsFileName(){return this.filepathToFileName(this.module.gameName,'.cheats')}createSaveState(a){return this.module.saveState(a)}loadSaveState(a){return this.module.loadState(a)}listSaveStates(){return this.module.FS.readdir(this.saveStatePath)}deleteSaveState(a){let b=this.filepathToFileName(this.module.saveName,'.ss'+a);const c=this.saveStatePath+'/'+b;this.module.FS.unlink(c)}pause(){this.isPaused=!0,this.module.pauseGame()}resume(){this.isPaused=!1,this.module.resumeGame()}getPaused(){return this.isPaused}getIsRunning(){return this.isRunning}setVolume(a){this.module.setVolume(a)}getVolume(){return this.module.getVolume()}setPixelated(a){$(this.module.canvas).toggleClass('pixelatedCanvas')}reset(){return this.quitGame(),this.isRunning=!1,!1}quickReload(){if(this.isRunning)this.module.quickReload();else if(this.module.gameName)var a=this.module.loadGame(this.module.gameName);else return!1;return!0}downloadSave(d){var b=this.module.getSave(),a,c;window.URL&&b&&(a=$("<a style='display: none;'/>"),c=window.URL.createObjectURL(new Blob([b],{type:'data:application/x-spss-sav'})),a.attr('href',c),a.attr('download',d),$('body').append(a),a[0].click(),window.URL.revokeObjectURL(c),a.remove())}getCurrentSave(){return this.module.getSave()}enableKeyboardInput(){this.module.toggleInput(!0)}disableKeyboardInput(){this.module.toggleInput(!1)}simulateKeyDown(a){this.module.buttonPress(a)}simulateKeyUp(a){this.module.buttonUnpress(a)}remapKeyBinding(b,c,a){a=a.replace(/arrow/gi,''),a==='Enter'&&(a='Return'),c==='32'&&(a='Space'),a&&b&&this.module.bindKey(a,b)}setFastForward(a,b){this.module.setMainLoopTiming(a,b)}_copyCanvas(){var a=document.createElement('canvas'),b,d;$(a).addClass('pixelatedCanvas'),b=a.getContext('2d'),b.mozImageSmoothingEnabled=!1,b.webkitImageSmoothingEnabled=!1,b.msImageSmoothingEnabled=!1,b.imageSmoothingEnabled=!1,a.height=$('#screenwrapper').height(),a.width=$('#screenwrapper').width(),d=document.getElementById('screen').getContext('webgl').canvas,b.drawImage(d,0,0,a.width,a.height);let e=a.toDataURL(),c=new Image;c.src=e;let f=window.open('');f.document.write(c.outerHTML)}screenShot(){this.module.screenShot(this._copyCanvas)}defaultKeyBindings(){return[{descrip:'Up',keybind:'Up'},{descrip:'Down',keybind:'Down'},{descrip:'Left',keybind:'Left'},{descrip:'Right',keybind:'Right'},{descrip:'A',keybind:'X'},{descrip:'B',keybind:'Z'},{descrip:'L',keybind:'A'},{descrip:'R',keybind:'S'},{descrip:'Start',keybind:'Enter'},{descrip:'Select',keybind:'Backspace'}]}quitGame(){this.module.quitGame(),this.isPaused=!1,this.isRunning=!1}quitEmulator(){this.module.quitMgba(),this.isPaused=!1,this.isRunning=!1}audioPolyfill(a=null){if(typeof this.module=='undefined'||typeof this.module.SDL2=='undefined'||typeof this.module.SDL2.audioContext=='undefined')return;this.module.SDL2.audioContext.state=='suspended'&&this.module.SDL2.audioContext.resume(),this.module.SDL2.audioContext.state=='running'&&a&&a()}lcdFade(){let b=this.module.canvas,a=b.getContext('webgl');a.viewport(0,0,b.width,b.height);const e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b.width,b.height,0,a.RGBA,a.UNSIGNED_BYTE,null);const j=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,j),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0);const f=new Float32Array([-1,1,-1,-1,1,1,1,-1]),g=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,g),a.bufferData(a.ARRAY_BUFFER,f,a.STATIC_DRAW),a.enableVertexAttribArray(0),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLE_STRIP,0,4);const c=new Uint8Array(b.width*b.height*4);a.readPixels(0,0,b.width,b.height,a.RGBA,a.UNSIGNED_BYTE,c);const h=getComputedStyle(b),i=h.backgroundColor,d=i.match(/\d+/g),k=d[0]/255,l=d[1]/255,m=d[2]/255;for(let a=3;a<c.length;a+=4)c[a]=Math.max(0,c[a]-10),c[a-3]=Math.round((1-c[a]/255)*k*255),c[a-2]=Math.round((1-c[a]/255)*l*255),c[a-1]=Math.round((1-c[a]/255)*m*255);a.bindTexture(a.TEXTURE_2D,e),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b.width,b.height,0,a.RGBA,a.UNSIGNED_BYTE,c),a.bindFramebuffer(a.FRAMEBUFFER,null),a.drawArrays(a.TRIANGLE_STRIP,0,4)}writeSav(a,b){var c=this.module.FS.writeFile(this.savePath+a,new Uint8Array(b));return c}writeCheats(a,b){var c=this.module.FS.writeFile(this.cheatsPath+a,new Uint8Array(b));return c}loadBuffer(b,c){var a=this.romPath+b,d;return this.module.FS.writeFile(a,new Uint8Array(c)),d=this.module.loadGame(a),d}filepathToFileName(c,b=null){let a=c.split('/').pop();if(b){const c='.'+a.split('.').pop();a=a.replace(c,b)}return a}}